---
title: "Contraste de métodos de imputación estadística en la documentación de víctimas del
conflicto armado colombiano"
author: "Valentina Gómez^[[valegome@ucm.es](valegome@ucm.es)]"
date: '`r format(Sys.time(), "%d %B %Y")`'
output: pdf_document
site: "bookdown::bookdown_site"
lang: es-CO
fig_width: 4
fig_height: 2.5
fontsize: 12pt
urlcolor: blue
editor_options: 
  markdown: 
    wrap: sentence
---
# Validación cruzada ML - Sexo

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(pacman)
p_load(here, tidyverse, dplyr, data.table, Matrix, vcd, xgboost, caret, ggplot2,
			 pROC, lightgbm, flextable, officer)

```

Importación de datos:

```{r}
input_dir <- here::here("06.union/output")
output_dir <- here::here("10.validacion_modelos/output/machine_learning/sexo")

data.dt <- readRDS(paste0(input_dir,"/violencias_unidas_aux.rds")) %>%
	as.data.table()
```
Se establecen los regresores que se utilizaron en el modelo

```{r}
# Prepare data (encodings)####
regressors_sexo <- c(
  "macroregion", "dept_code_hecho", "muni_code_hecho", "areaoficialkm2_mpio", "discapital_mpio", "frontera_mpio",
  "yy_hecho",
  "violencia", 
  "etnia", "p_str", "edad_categoria",
  "pobl_tot_mpio", "indrural_mpio", "predo_rural_mpio",
  "y_transf_depto", "g_func_general_depto",  
  "H_coca_depto",
  "asistesc_depto", "per_alfa_depto", "alumn_total_depto")

```

Me quedo con las observaciones que están completas:

```{r}
data.dt<-data.dt[complete.cases(data.dt),]
dim(data.dt)
colSums(is.na(data.dt))

```

Divido la base de datos en 5 grupos del mismo tamaño de manera aleatoria: 

```{r}
set.seed(123)

data.dt <- data.dt %>%
  group_by(violencia) %>%
  mutate(grupo = sample(rep(1:5, length.out = n())))

table(data.dt$violencia, data.dt$grupo)

```

Genero valores NA's para un grupo de cada violencia y dejo los otros 4 grupos como parte del entrenamiento: 

```{r}
violencias_artificial_nas_1 <- data.dt %>%
	mutate(sexo_real = sexo,
				 sexo = case_when(grupo == 1 ~ NA,
													TRUE ~ sexo)) %>%
	select(-grupo) %>%
	as.data.table()


violencias_artificial_nas_2 <- data.dt %>%
	mutate(sexo_real = sexo,
		sexo = case_when(grupo == 2 ~ NA,
													TRUE ~ sexo)) %>%
	select(-grupo) %>%
	as.data.table()

violencias_artificial_nas_3 <- data.dt %>%
	mutate(sexo_real = sexo,
		sexo = case_when(grupo == 3 ~ NA,
													TRUE ~ sexo)) %>%
	select(-grupo) %>%
	as.data.table()

violencias_artificial_nas_4 <- data.dt %>%
	mutate(sexo_real = sexo,
		sexo = case_when(grupo == 4 ~ NA,
													TRUE ~ sexo)) %>%
	select(-grupo) %>%
	as.data.table()

violencias_artificial_nas_5 <- data.dt %>%
	mutate(sexo_real = sexo,
		sexo = case_when(grupo == 5 ~ NA,
													TRUE ~ sexo)) %>%
	select(-grupo) %>%
	as.data.table()

```

Encode de las variables en cada grupo artificial (mismo codigo de la imputación, pero lo realizo para cada grupo artificial con NAs que se ha generado antes): 


```{r}
impute_sexo_model <- function(data, output_file_prefix, tipo_violencia) {
  # Filtrar los datos por el tipo de violencia
  data_filter <- data %>%
    filter(violencia == tipo_violencia)
  
  df <- data_filter[
    , c('sexo', 'sexo_real', regressors_sexo), with = FALSE][
    , yy_hecho := as.numeric(yy_hecho)][
    , dept_code_hecho := as.numeric(dept_code_hecho)][
    , muni_code_hecho := as.numeric(muni_code_hecho)][
    is.na(etnia), etnia := '*'][
    is.na(edad_categoria), edad_categoria := '*'][
    is.na(p_str), p_str := '*']
  
  # Codificación de variables categóricas
  macroregion_levels <- sort(unique(df$macroregion))
  macroregion_enc <- seq_along(macroregion_levels) - 1
  names(macroregion_enc) <- macroregion_levels
  
  violencia_levels <- sort(unique(df$violencia))
  violencia_enc <- seq_along(violencia_levels) - 1
  names(violencia_enc) <- violencia_levels
  
  pstr_levels <- sort(unique(df$p_str))
  pstr_enc <- seq_along(pstr_levels) - 1
  names(pstr_enc) <- pstr_levels
  
  etnia_levels <- sort(unique(df$etnia))
  etnia_enc <- seq_along(etnia_levels) - 1
  names(etnia_enc) <- etnia_levels
  
  edadCat_levels <- sort(unique(df$edad_categoria))
  edadCat_enc <- seq_along(edadCat_levels) - 1
  names(edadCat_enc) <- edadCat_levels
  
  edadJep_levels <- sort(unique(df$edad_jep))
  edadJep_enc <- seq_along(edadJep_levels) - 1
  names(edadJep_enc) <- edadJep_levels
  
  sexo_levels <- sort(unique(df$sexo))
  sexo_enc <- seq_along(sexo_levels) - 1
  names(sexo_enc) <- sexo_levels
  
  data_enc.dt <- copy(df)[
    , sexo := sexo_enc[sexo]][
    , macroregion := macroregion_enc[macroregion]][
    , violencia := violencia_enc[violencia]][
    , etnia := etnia_enc[etnia]][
    , p_str := pstr_enc[p_str]][
    , edad_categoria := edadCat_enc[edad_categoria]]

  # Dividir los datos en casos completos y casos faltantes
  data_sexo_enc.dt <- data_enc.dt[!is.na(sexo)]
  data_sexo_enc_impute.dt <- data_enc.dt[is.na(sexo)]

  # Submuestreo para balancear las clases
  n_mujeres <- data_sexo_enc.dt[sexo == 1, .N]
  n_hombres <- data_sexo_enc.dt[sexo == 0, .N]

  set.seed(412)
  data_sexo_undersampl.dt <- rbindlist(list(
    data_sexo_enc.dt[sexo == 0][
      sample(c(TRUE, FALSE), n_hombres, prob = c(n_mujeres / n_hombres, 1 - n_mujeres / n_hombres), replace = TRUE)],
    data_sexo_enc.dt[sexo == 1]))

  # Construcción del modelo
  data_sexo_train <- lgb.Dataset(
    Matrix(as.matrix(data_sexo_undersampl.dt[, -c(1,2)]), sparse = TRUE), 
    label = data_sexo_undersampl.dt$sexo,
    categorical_feature = c(1L, 2L, 3L, 6L, 8L, 9L, 10L, 11L)
  )

  lgb_grid <- list(
    objective = "binary",
    metric    = "auc",
    bagging_freq = 5,
    force_row_wise = TRUE
  )

  model_sexo_impute <- lightgbm(
    data = data_sexo_train, 
    params = lgb_grid, 
    nrounds = 5000L, 
    verbose = 2L
  )

  # Evaluación del modelo
  prob_sexo_train <- predict(model_sexo_impute, Matrix(as.matrix(data_sexo_undersampl.dt[, -c(1,2)]), sparse = TRUE))
  roc_sexo_train <- roc(data_sexo_undersampl.dt$sexo, prob_sexo_train)
  
  thrsh <- coords(roc_sexo_train, 'best', best.method="closest.topleft")[["threshold"]]
  data_sexo_undersampl.dt[
    , prob_mujer := prob_sexo_train][
    , sexo_pred := ifelse(prob_mujer >= thrsh, 1, 0)]

  # Matriz de confusión
  confMat_sexo_train <- confusionMatrix(
    factor(data_sexo_undersampl.dt$sexo_pred, levels = 0:1), 
    factor(data_sexo_undersampl.dt$sexo, levels = 0:1)
  )

  # Imputar sexo en los datos faltantes
  data_sexo_impute <- Matrix(as.matrix(data_sexo_enc_impute.dt[, -c(1,2)]), sparse = TRUE)
  prob_sexo_impute <- predict(model_sexo_impute, data_sexo_impute)

  data_sexo_enc_impute.dt[
    , prob_mujer := prob_sexo_impute][
    , sexo := ifelse(prob_mujer >= thrsh, 1, 0)]

  sexo_imp_enc <- data_sexo_enc_impute.dt$sexo
  sexo_imputed <- ifelse(sexo_imp_enc == 0, 'HOMBRE', 'MUJER')

  data_sexo_imputed.dt <- copy(df)[
    , sexo_imp := ifelse(is.na(sexo), TRUE, FALSE)][
    is.na(sexo), sexo := sexo_imputed]

  # Guardar los datos imputados
 # saveRDS(data_sexo_imputed.dt, paste0(output_dir,"/", output_file_prefix, ".rds"))
  
  # Retornar los objetos
  return(list(
    confMat_sexo_train = confMat_sexo_train,
    roc_sexo_train = roc_sexo_train,
    prob_sexo_train = prob_sexo_train,
    thrsh = thrsh,
    data_sexo_imputed.dt = data_sexo_imputed.dt
  ))
}



# Tipos de violencia a procesar
tipos_violencia <- c("desaparicion", "homicidio", "reclutamiento", "secuestro")

# Periodos de años a procesar
periodos <- list(
  c(1998, 2016)
)

# Lista para almacenar los resultados
resultados_imputacion_sexo1 <- list()
resultados_imputacion_sexo2 <- list()
resultados_imputacion_sexo3 <- list()
resultados_imputacion_sexo4 <- list()
resultados_imputacion_sexo5 <- list()

# Grupo 1

# Procesar cada combinación de tipo de violencia y periodo de años
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    data_filtrada <- violencias_artificial_nas_1 %>%
      filter(violencia == tipo,
             yy_hecho >= start_year & yy_hecho <= end_year)
        resultado_imputacion1 <- impute_sexo_model(data_filtrada, paste0(tipo, "_", start_year, "_", end_year), tipo)
        resultados_imputacion_sexo1[[paste(tipo, start_year, end_year, sep = "_")]] <- resultado_imputacion1
  }
}

saveRDS(resultados_imputacion_sexo1, (paste0(output_dir,"/artif_ml_sexo_light1.rds")))

# Grupo 2

# Procesar cada combinación de tipo de violencia y periodo de años
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    data_filtrada <- violencias_artificial_nas_2 %>%
      filter(violencia == tipo,
             yy_hecho >= start_year & yy_hecho <= end_year)
        resultado_imputacion2 <- impute_sexo_model(data_filtrada, paste0(tipo, "_", start_year, "_", end_year), tipo)
        resultados_imputacion_sexo2[[paste(tipo, start_year, end_year, sep = "_")]] <- resultado_imputacion2
  }
}

saveRDS(resultados_imputacion_sexo2, (paste0(output_dir,"/artif_ml_sexo_light2.rds")))

# Grupo 3

# Procesar cada combinación de tipo de violencia y periodo de años
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    data_filtrada <- violencias_artificial_nas_3 %>%
      filter(violencia == tipo,
             yy_hecho >= start_year & yy_hecho <= end_year)
        resultado_imputacion3 <- impute_sexo_model(data_filtrada, paste0(tipo, "_", start_year, "_", end_year), tipo)
        resultados_imputacion_sexo3[[paste(tipo, start_year, end_year, sep = "_")]] <- resultado_imputacion3
  }
}

saveRDS(resultados_imputacion_sexo3, (paste0(output_dir,"/artif_ml_sexo_light3.rds")))

# Grupo 4

# Procesar cada combinación de tipo de violencia y periodo de años
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    data_filtrada <- violencias_artificial_nas_4 %>%
      filter(violencia == tipo,
             yy_hecho >= start_year & yy_hecho <= end_year)
        resultado_imputacion4 <- impute_sexo_model(data_filtrada, paste0(tipo, "_", start_year, "_", end_year), tipo)
        resultados_imputacion_sexo4[[paste(tipo, start_year, end_year, sep = "_")]] <- resultado_imputacion4
  }
}

saveRDS(resultados_imputacion_sexo4, (paste0(output_dir,"/artif_ml_sexo_light4.rds")))

# Grupo 5

# Procesar cada combinación de tipo de violencia y periodo de años
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    data_filtrada <- violencias_artificial_nas_5 %>%
      filter(violencia == tipo,
             yy_hecho >= start_year & yy_hecho <= end_year)
        resultado_imputacion5 <- impute_sexo_model(data_filtrada, paste0(tipo, "_", start_year, "_", end_year), tipo)
        resultados_imputacion_sexo5[[paste(tipo, start_year, end_year, sep = "_")]] <- resultado_imputacion5
  }
}

saveRDS(resultados_imputacion_sexo5, (paste0(output_dir,"/artif_ml_sexo_light5.rds")))



```


Importo los resultados guardados (por si no se quiere volver a ejecutar toda la imputación anterior):

```{r}

artif_ml_sexo_1 <- readRDS(paste0(output_dir,"/artif_ml_sexo_light1.rds"))
artif_ml_sexo_2 <- readRDS(paste0(output_dir,"/artif_ml_sexo_light2.rds"))
artif_ml_sexo_3 <- readRDS(paste0(output_dir,"/artif_ml_sexo_light3.rds"))
artif_ml_sexo_4 <- readRDS(paste0(output_dir,"/artif_ml_sexo_light4.rds"))
artif_ml_sexo_5 <- readRDS(paste0(output_dir,"/artif_ml_sexo_light5.rds"))

```

Funciones para hacer descriptivos: 

```{r}
generate_indicators_summary <- function(data) {
  required_cols <- c("diferentes", "wrai")
  if (!all(required_cols %in% colnames(data))) {
    stop("Faltan una o más columnas necesarias en los datos.")
  }
  
  stats_summary <- data.table(
    Metric = c("diferentes", "wrai"),
    Min = c(
      # round(min(data$iguales, na.rm = TRUE), 0),
      round(min(data$diferentes, na.rm = TRUE), 0),
      paste0(round(min(data$wrai, na.rm = TRUE)*100, 2), "%")
    ),
    `1st_Qu.` = c(
      # round(quantile(data$iguales, 0.25, na.rm = TRUE), 0),
      round(quantile(data$diferentes, 0.25, na.rm = TRUE), 0),
      paste0(round(quantile(data$wrai, 0.25, na.rm = TRUE)*100, 2), "%")
    ),
    Median = c(
      # round(median(data$iguales, na.rm = TRUE), 0),
      round(median(data$diferentes, na.rm = TRUE), 0),
      paste0(round(median(data$wrai, na.rm = TRUE)*100, 2), "%")
    ),
    Mean = c(
      # round(mean(data$iguales, na.rm = TRUE), 0),
      round(mean(data$diferentes, na.rm = TRUE), 0),
      paste0(round(mean(data$wrai, na.rm = TRUE)*100, 2), "%")
    ),
    `3rd_Qu.` = c(
      # round(quantile(data$iguales, 0.75, na.rm = TRUE), 0),
      round(quantile(data$diferentes, 0.75, na.rm = TRUE), 0),
      paste0(round(quantile(data$wrai, 0.75, na.rm = TRUE)*100, 2), "%")
    ),
    Max = c(
      # round(max(data$iguales, na.rm = TRUE), 0),
      round(max(data$diferentes, na.rm = TRUE), 0),
      paste0(round(max(data$wrai, na.rm = TRUE)*100, 2), "%")
    ),
    SD = c(
      # round(sd(data$iguales, na.rm = TRUE), 2),
      round(sd(data$diferentes, na.rm = TRUE), 2),
      paste0(round(sd(data$wrai, na.rm = TRUE)*100, 2), "%")
    )
  )
  
  return(stats_summary)
}


generate_cv_summary <- function(metrics_df) {
  metrics_dt <- as.data.table(metrics_df)
  
  stats_summary <- data.table(
    Metric = colnames(metrics_dt),
    Min = paste0(sapply(metrics_dt, function(x) round(min(x, na.rm = TRUE)*100, 2)), "%"),
    `1st_Qu.` = paste0(sapply(metrics_dt, function(x) round(quantile(x, 0.25, na.rm = TRUE)*100, 2)), "%"),
    Median = paste0(sapply(metrics_dt, function(x) round(median(x, na.rm = TRUE)*100, 2)), "%"),
    Mean = paste0(sapply(metrics_dt, function(x) round(mean(x, na.rm = TRUE)*100, 2)), "%"),
    `3rd_Qu.` = paste0(sapply(metrics_dt, function(x) round(quantile(x, 0.75, na.rm = TRUE)*100, 2)), "%"),
    Max = paste0(sapply(metrics_dt, function(x) round(max(x, na.rm = TRUE)*100, 2)), "%"),
    SD = paste0(sapply(metrics_dt, function(x) round(sd(x, na.rm = TRUE)*100, 2)), "%")
  )
  
  return(stats_summary)
}

```

# Desaparición

```{r}
comparison_data <- function(data, k_value) {
  data[, .(
    iguales = sum(sexo_real == sexo, na.rm = TRUE),
    diferentes = sum(sexo_real != sexo, na.rm = TRUE),
    k = k_value
  )][, wrai := round(diferentes / (iguales + diferentes), 4)]
}

comparison_desap1 <- comparison_data(artif_ml_sexo_1[["desaparicion_1998_2016"]][["data_sexo_imputed.dt"]], "1")
comparison_desap2 <- comparison_data(artif_ml_sexo_2[["desaparicion_1998_2016"]][["data_sexo_imputed.dt"]], "2")
comparison_desap3 <- comparison_data(artif_ml_sexo_3[["desaparicion_1998_2016"]][["data_sexo_imputed.dt"]], "3")
comparison_desap4 <- comparison_data(artif_ml_sexo_4[["desaparicion_1998_2016"]][["data_sexo_imputed.dt"]], "4")
comparison_desap5 <- comparison_data(artif_ml_sexo_5[["desaparicion_1998_2016"]][["data_sexo_imputed.dt"]], "5")

comparison_desap <- rbindlist(list(comparison_desap1, comparison_desap2, comparison_desap3, comparison_desap4, comparison_desap5)) %>%
	select(k, iguales, diferentes, wrai)

# Extraer estadísticos de los 5 folds
stats_summary_desap <- generate_indicators_summary(comparison_desap)
stats_summary_desap

```

Métricas de la matriz de confusión:

```{r}

model_names <- c("artif_ml_sexo_1", "artif_ml_sexo_2", "artif_ml_sexo_3", "artif_ml_sexo_4", "artif_ml_sexo_5")

# métricas 
extract_metrics <- function(model_name) {
  model <- get(model_name)
  metrics <- list(
    Accuracy = model[["desaparicion_1998_2016"]][["confMat_sexo_train"]][["overall"]][["Accuracy"]],
    Sensitivity = model[["desaparicion_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Sensitivity"]],
    Specificity = model[["desaparicion_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Specificity"]],
    Pos_Pred_Value = model[["desaparicion_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Pos Pred Value"]],
    Neg_Pred_Value = model[["desaparicion_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Neg Pred Value"]],
    Balanced_Accuracy = model[["desaparicion_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Balanced Accuracy"]]
  )
  return(metrics)
}

metrics_list_desap <- lapply(model_names, extract_metrics)
metrics_df_desap <- do.call(rbind, lapply(metrics_list_desap, as.data.frame))


metrics_cv_desap <- generate_cv_summary(metrics_df_desap)
metrics_cv_desap

```

# Homicidio

```{r}
comparison_data <- function(data, k_value) {
  data[, .(
    iguales = sum(sexo_real == sexo, na.rm = TRUE),
    diferentes = sum(sexo_real != sexo, na.rm = TRUE),
    k = k_value
  )][, wrai := round(diferentes / (iguales + diferentes), 4)]
}

comparison_homi1 <- comparison_data(artif_ml_sexo_1[["homicidio_1998_2016"]][["data_sexo_imputed.dt"]], "1")
comparison_homi2 <- comparison_data(artif_ml_sexo_2[["homicidio_1998_2016"]][["data_sexo_imputed.dt"]], "2")
comparison_homi3 <- comparison_data(artif_ml_sexo_3[["homicidio_1998_2016"]][["data_sexo_imputed.dt"]], "3")
comparison_homi4 <- comparison_data(artif_ml_sexo_4[["homicidio_1998_2016"]][["data_sexo_imputed.dt"]], "4")
comparison_homi5 <- comparison_data(artif_ml_sexo_5[["homicidio_1998_2016"]][["data_sexo_imputed.dt"]], "5")

comparison_homi <- rbindlist(list(comparison_homi1, comparison_homi2, comparison_homi3, comparison_homi4, comparison_homi5)) %>%
	select(k, iguales, diferentes, wrai)

# Extraer estadísticos de los 5 folds
stats_summary_homi <- generate_indicators_summary(comparison_homi)
stats_summary_homi

```

Métricas de la matriz de confusión:

```{r}

model_names <- c("artif_ml_sexo_1", "artif_ml_sexo_2", "artif_ml_sexo_3", "artif_ml_sexo_4", "artif_ml_sexo_5")

# métricas 
extract_metrics <- function(model_name) {
  model <- get(model_name)
  metrics <- list(
    Accuracy = model[["homicidio_1998_2016"]][["confMat_sexo_train"]][["overall"]][["Accuracy"]],
    Sensitivity = model[["homicidio_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Sensitivity"]],
    Specificity = model[["homicidio_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Specificity"]],
    Pos_Pred_Value = model[["homicidio_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Pos Pred Value"]],
    Neg_Pred_Value = model[["homicidio_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Neg Pred Value"]],
    Balanced_Accuracy = model[["homicidio_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Balanced Accuracy"]]
  )
  return(metrics)
}

metrics_list_homi <- lapply(model_names, extract_metrics)
metrics_df_homi <- do.call(rbind, lapply(metrics_list_homi, as.data.frame))


metrics_cv_homi <- generate_cv_summary(metrics_df_homi)
metrics_cv_homi

```


# Reclutamiento

```{r}
comparison_data <- function(data, k_value) {
  data[, .(
    iguales = sum(sexo_real == sexo, na.rm = TRUE),
    diferentes = sum(sexo_real != sexo, na.rm = TRUE),
    k = k_value
  )][, wrai := round(diferentes / (iguales + diferentes), 4)]
}

comparison_reclu1 <- comparison_data(artif_ml_sexo_1[["reclutamiento_1998_2016"]][["data_sexo_imputed.dt"]], "1")
comparison_reclu2 <- comparison_data(artif_ml_sexo_2[["reclutamiento_1998_2016"]][["data_sexo_imputed.dt"]], "2")
comparison_reclu3 <- comparison_data(artif_ml_sexo_3[["reclutamiento_1998_2016"]][["data_sexo_imputed.dt"]], "3")
comparison_reclu4 <- comparison_data(artif_ml_sexo_4[["reclutamiento_1998_2016"]][["data_sexo_imputed.dt"]], "4")
comparison_reclu5 <- comparison_data(artif_ml_sexo_5[["reclutamiento_1998_2016"]][["data_sexo_imputed.dt"]], "5")

comparison_reclu <- rbindlist(list(comparison_reclu1, comparison_reclu2, comparison_reclu3, comparison_reclu4, comparison_reclu5)) %>%
	select(k, iguales, diferentes, wrai)

# Extraer estadísticos de los 5 folds
stats_summary_reclu <- generate_indicators_summary(comparison_reclu)
stats_summary_reclu

```

Métricas de la matriz de confusión:

```{r}

model_names <- c("artif_ml_sexo_1", "artif_ml_sexo_2", "artif_ml_sexo_3", "artif_ml_sexo_4", "artif_ml_sexo_5")

# métricas 
extract_metrics <- function(model_name) {
  model <- get(model_name)
  metrics <- list(
    Accuracy = model[["reclutamiento_1998_2016"]][["confMat_sexo_train"]][["overall"]][["Accuracy"]],
    Sensitivity = model[["reclutamiento_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Sensitivity"]],
    Specificity = model[["reclutamiento_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Specificity"]],
    Pos_Pred_Value = model[["reclutamiento_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Pos Pred Value"]],
    Neg_Pred_Value = model[["reclutamiento_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Neg Pred Value"]],
    Balanced_Accuracy = model[["reclutamiento_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Balanced Accuracy"]]
  )
  return(metrics)
}

metrics_list_reclu <- lapply(model_names, extract_metrics)
metrics_df_reclu <- do.call(rbind, lapply(metrics_list_reclu, as.data.frame))


metrics_cv_reclu <- generate_cv_summary(metrics_df_reclu)
metrics_cv_reclu

```

# Secuestro

```{r}
comparison_data <- function(data, k_value) {
  data[, .(
    iguales = sum(sexo_real == sexo, na.rm = TRUE),
    diferentes = sum(sexo_real != sexo, na.rm = TRUE),
    k = k_value
  )][, wrai := round(diferentes / (iguales + diferentes), 4)]
}

comparison_secue1 <- comparison_data(artif_ml_sexo_1[["secuestro_1998_2016"]][["data_sexo_imputed.dt"]], "1")
comparison_secue2 <- comparison_data(artif_ml_sexo_2[["secuestro_1998_2016"]][["data_sexo_imputed.dt"]], "2")
comparison_secue3 <- comparison_data(artif_ml_sexo_3[["secuestro_1998_2016"]][["data_sexo_imputed.dt"]], "3")
comparison_secue4 <- comparison_data(artif_ml_sexo_4[["secuestro_1998_2016"]][["data_sexo_imputed.dt"]], "4")
comparison_secue5 <- comparison_data(artif_ml_sexo_5[["secuestro_1998_2016"]][["data_sexo_imputed.dt"]], "5")

comparison_secue <- rbindlist(list(comparison_secue1, comparison_secue2, comparison_secue3, comparison_secue4, comparison_secue5)) %>%
	select(k, iguales, diferentes, wrai)

# Extraer estadísticos de los 5 folds
stats_summary_secue <- generate_indicators_summary(comparison_secue)
stats_summary_secue

```

Métricas de la matriz de confusión:

```{r}

model_names <- c("artif_ml_sexo_1", "artif_ml_sexo_2", "artif_ml_sexo_3", "artif_ml_sexo_4", "artif_ml_sexo_5")

# métricas 
extract_metrics <- function(model_name) {
  model <- get(model_name)
  metrics <- list(
    Accuracy = model[["secuestro_1998_2016"]][["confMat_sexo_train"]][["overall"]][["Accuracy"]],
    Sensitivity = model[["secuestro_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Sensitivity"]],
    Specificity = model[["secuestro_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Specificity"]],
    Pos_Pred_Value = model[["secuestro_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Pos Pred Value"]],
    Neg_Pred_Value = model[["secuestro_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Neg Pred Value"]],
    Balanced_Accuracy = model[["secuestro_1998_2016"]][["confMat_sexo_train"]][["byClass"]][["Balanced Accuracy"]]
  )
  return(metrics)
}

metrics_list_secue <- lapply(model_names, extract_metrics)
metrics_df_secue <- do.call(rbind, lapply(metrics_list_secue, as.data.frame))


metrics_cv_secue <- generate_cv_summary(metrics_df_secue)
metrics_cv_secue

```




