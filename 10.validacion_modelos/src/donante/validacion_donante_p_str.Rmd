---
title: "Contraste de métodos de imputación estadística en la documentación de víctimas del
conflicto armado colombiano"
author: "Valentina Gómez^[[valegome@ucm.es](valegome@ucm.es)]"
date: '`r format(Sys.time(), "%d %B %Y")`'
output: pdf_document
site: "bookdown::bookdown_site"
lang: es-CO
fig_width: 4
fig_height: 2.5
fontsize: 12pt
urlcolor: blue
editor_options: 
  markdown: 
    wrap: sentence
---
# Validación cruzada modelos - Perpetrador

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(pacman)
p_load(here, readr, tidyverse, dplyr, validate, data.table, missForest, 
			 VIM, lattice, simputation, mice, skimr, compareDF, caret)

```

Importación de datos:

```{r}
input_dir <- here::here("06.union/output")
output_dir <- here::here("10.validacion_modelos/output/donante/p_str")

violencias_unidas_aux <- readRDS(paste0(input_dir,"/violencias_unidas_aux.rds")) %>%
	as.data.table()

colSums(is.na(violencias_unidas_aux))
dim(violencias_unidas_aux)

```

Me quedo con las observaciones que están completas:

```{r}
complete_violencias_unidas_aux<-violencias_unidas_aux[complete.cases(violencias_unidas_aux),]
dim(complete_violencias_unidas_aux)

rm(violencias_unidas_aux)
```

Divido la base de datos en 5 grupos del mismo tamaño de manera aletoria: 

```{r}
set.seed(123)

complete_violencias_unidas_aux <- complete_violencias_unidas_aux %>%
  group_by(violencia) %>%
  mutate(grupo = sample(rep(1:5, length.out = n())))

table(complete_violencias_unidas_aux$violencia, complete_violencias_unidas_aux$grupo)

```

Genero valores NA's para un grupo de cada violencia y dejo los otros 4 grupos como parte del entrenamiento: 

```{r}
violencias_artificial_nas_1 <- complete_violencias_unidas_aux %>%
	mutate(p_str = case_when(grupo == 1 ~ NA,
													TRUE ~ p_str))

table(violencias_artificial_nas_1$violencia, 
			violencias_artificial_nas_1$grupo,
			violencias_artificial_nas_1$p_str, useNA = "always")


violencias_artificial_nas_2 <- complete_violencias_unidas_aux %>%
	mutate(p_str = case_when(grupo == 2 ~ NA,
													TRUE ~ p_str))

violencias_artificial_nas_3 <- complete_violencias_unidas_aux %>%
	mutate(p_str = case_when(grupo == 3 ~ NA,
													TRUE ~ p_str))

violencias_artificial_nas_4 <- complete_violencias_unidas_aux %>%
	mutate(p_str = case_when(grupo == 4 ~ NA,
													TRUE ~ p_str))

violencias_artificial_nas_5 <- complete_violencias_unidas_aux %>%
	mutate(p_str = case_when(grupo == 5 ~ NA,
													TRUE ~ p_str))

```

Se imputa por Donante por periodos de tiempo (usando la misma imputación que 08.modelos_imputacion). Se hace para cada grupo como test y el resto como training:

```{r}
# Función para el procesamiento de distintos tipos de violencia en un rango de años

procesar_violencia <- function(data, tipo_violencia, start_year, end_year) {
  violencia_filtrada <- data %>%
    filter(violencia == tipo_violencia,
           yy_hecho >= start_year & yy_hecho <= end_year) %>%
    select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
           discapital_mpio, predo_rural_mpio, areaoficialkm2_mpio,
           asistesc_depto, per_alfa_depto, alumn_total_depto,
           y_transf_depto, g_func_general_depto,
    			 H_coca_depto, frontera_mpio, p_str)
  
  print(paste("NA counts for", tipo_violencia, "from", start_year, "to", end_year))
  print(colSums(is.na(violencia_filtrada)))
  
  violencia_imp <- violencia_filtrada  |>
    impute_knn(p_str  ~ yy_hecho + muni_code_hecho + dept_code_hecho +
                     discapital_mpio + predo_rural_mpio + areaoficialkm2_mpio +
                     asistesc_depto + per_alfa_depto + alumn_total_depto +
                     y_transf_depto + g_func_general_depto+
    					 	     H_coca_depto + frontera_mpio,
               backend = 'VIM')
  
  print(paste("NA counts after imputation for", tipo_violencia, "from", start_year, "to", end_year))
  print(colSums(is.na(violencia_imp)))
  
  imputed_flags <- as.data.frame(is.na(violencia_filtrada) & !is.na(violencia_imp))
  
  violencia_imp$p_str_imputed <- imputed_flags$p_str
  
  result <- violencia_imp  %>%
	select(match_group_id, muni_code_hecho, yy_hecho, p_str) %>%
	mutate(p_str_donante = p_str) %>%
	select(-p_str)
  
  return(result)
}

# Tipos de violencia a procesar
tipos_violencia <- c("desaparicion", "homicidio", "reclutamiento", "secuestro")

# Periodos de años a procesar
periodos <- list(
  c(1998, 2016)
)

# Lista para almacenar los resultados
artif_donante_p_str_1 <- list()
artif_donante_p_str_2 <- list()
artif_donante_p_str_3 <- list()
artif_donante_p_str_4 <- list()
artif_donante_p_str_5 <- list()

# Procesar cada combinación de tipo de violencia y periodo de años

# Grupo 1
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result1 <- procesar_violencia(violencias_artificial_nas_1, tipo, start_year, end_year)
    artif_donante_p_str_1[[paste(tipo, start_year, end_year, sep = "_")]] <- result1
  }
}

saveRDS(artif_donante_p_str_1, (paste0(output_dir,"/artif_donante_p_str_1.rds")))
rm(artif_donante_p_str_1, result1)

# Grupo 2
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result2 <- procesar_violencia(violencias_artificial_nas_2, tipo, start_year, end_year)
    artif_donante_p_str_2[[paste(tipo, start_year, end_year, sep = "_")]] <- result2
  }
}

saveRDS(artif_donante_p_str_2, (paste0(output_dir,"/artif_donante_p_str_2.rds")))
rm(artif_donante_p_str_2, result2)

# Grupo 3
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result3 <- procesar_violencia(violencias_artificial_nas_3, tipo, start_year, end_year)
    artif_donante_p_str_3[[paste(tipo, start_year, end_year, sep = "_")]] <- result3
  }
}

saveRDS(artif_donante_p_str_3, (paste0(output_dir,"/artif_donante_p_str_3.rds")))
rm(artif_donante_p_str_3, result3)

# Grupo 4
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result4 <- procesar_violencia(violencias_artificial_nas_4, tipo, start_year, end_year)
    artif_donante_p_str_4[[paste(tipo, start_year, end_year, sep = "_")]] <- result4
  }
}

saveRDS(artif_donante_p_str_4, (paste0(output_dir,"/artif_donante_p_str_4.rds")))
rm(artif_donante_p_str_4, result4)

# Grupo 5
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result5 <- procesar_violencia(violencias_artificial_nas_5, tipo, start_year, end_year)
    artif_donante_p_str_5[[paste(tipo, start_year, end_year, sep = "_")]] <- result5
  }
}

saveRDS(artif_donante_p_str_5, (paste0(output_dir,"/artif_donante_p_str_5.rds")))
rm(artif_donante_p_str_5, result5)

```

Importo los resultados guardados:

```{r}

artif_donante_p_str_1 <- readRDS(paste0(output_dir,"/artif_donante_p_str_1.rds"))
artif_donante_p_str_2 <- readRDS(paste0(output_dir,"/artif_donante_p_str_2.rds"))
artif_donante_p_str_3 <- readRDS(paste0(output_dir,"/artif_donante_p_str_3.rds"))
artif_donante_p_str_4 <- readRDS(paste0(output_dir,"/artif_donante_p_str_4.rds"))
artif_donante_p_str_5 <- readRDS(paste0(output_dir,"/artif_donante_p_str_5.rds"))

```

Función para indicadores de impacto de la detección y tratamiento de errores: 

```{r}

# Calcular WAI y WRAI
calcular_impacto <- function(donante_cols, observaciones, datos) {
  wai <- sapply(donante_cols, function(col) sum(datos[[col]] - datos[[observaciones]]))
  wrai <- sapply(donante_cols, function(col) sum(datos[[col]] - datos[[observaciones]]) / sum(datos[[observaciones]]))
  
  list(
    wai = wai,
    mean_wai = mean(wai),
    wrai = wrai,
    mean_wrai = mean(wrai)
  )
}


# Columnas de donantes y observaciones para Estado
donante_cols_estado <- paste0("estado_donante", 1:5)
observaciones_estado <- "estado_obs"

# Columnas de donantes y observaciones para ELN
donante_cols_eln <- paste0("eln_donante", 1:5)
observaciones_eln <- "eln_obs"

# Columnas de donantes y observaciones para FARC
donante_cols_farc <- paste0("farc_donante", 1:5)
observaciones_farc <- "farc_obs"

# Columnas de donantes y observaciones para OTRA GUERRILLA
donante_cols_gue_otro <- paste0("gue_otro_donante", 1:5)
observaciones_gue_otro <- "gue_otro_obs"

# Columnas de donantes y observaciones para Múltiple
donante_cols_multi <- paste0("multi_donante", 1:5)
observaciones_multi <- "multi_obs"

# Columnas de donantes y observaciones para Otro actor
donante_cols_otro <- paste0("otro_donante", 1:5)
observaciones_otro <- "otro_obs"

# Columnas de donantes y observaciones para Paramilitares
donante_cols_para <- paste0("para_donante", 1:5)
observaciones_para <- "para_obs"
```


# Desaparición:

Se unen los datos reales a los datos imputados para cada uno de los grupos:
```{r}
# Desaparición

artif_donante_p_str_desap1 <- (artif_donante_p_str_1[["desaparicion_1998_2016"]])
artif_donante_p_str_desap2 <- (artif_donante_p_str_2[["desaparicion_1998_2016"]])
artif_donante_p_str_desap3 <- (artif_donante_p_str_3[["desaparicion_1998_2016"]])
artif_donante_p_str_desap4 <- (artif_donante_p_str_4[["desaparicion_1998_2016"]])
artif_donante_p_str_desap5 <- (artif_donante_p_str_5[["desaparicion_1998_2016"]])


comparacion_desap <- complete_violencias_unidas_aux %>%
	filter(violencia == "desaparicion") %>%
	select(match_group_id, muni_code_hecho, yy_hecho, p_str) %>%
	mutate(p_str_obs = as.factor(p_str)) %>%
	select(-p_str) %>%
	merge(artif_donante_p_str_desap1, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante1 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_desap2, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante2 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_desap3, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante3 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_desap4, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante4 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_desap5, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante5 = as.factor(p_str_donante)) %>% select(-p_str_donante)

```

Matriz de confusión:

```{r}
# Columnas a comparar
donante_cols <- c("p_str_donante1", "p_str_donante2", "p_str_donante3", "p_str_donante4", "p_str_donante5")

metrics_list <- list()
sensitivity_list <- c()
specificity_list <- c()
pos_pred_value_list <- c()
neg_pred_value_list <- c()
balanced_accuracy_list <- c()

# Calcular matrices de confusión 
for (col in donante_cols) {
  conf_matrix <- confusionMatrix(comparacion_desap[[col]], comparacion_desap$p_str_obs)
  
  # Guardar métricas generales
  metrics_list[[col]] <- conf_matrix$overall
  
  # Guardar métricas específicas
  sensitivity_list <- c(sensitivity_list, conf_matrix$byClass[, "Sensitivity"])
  specificity_list <- c(specificity_list, conf_matrix$byClass[, "Specificity"])
  pos_pred_value_list <- c(pos_pred_value_list, conf_matrix$byClass[, "Pos Pred Value"])
  neg_pred_value_list <- c(neg_pred_value_list, conf_matrix$byClass[, "Neg Pred Value"])
  balanced_accuracy_list <- c(balanced_accuracy_list, conf_matrix$byClass[, "Balanced Accuracy"])

}

# Crear un data frame con las métricas de cada matriz de confusión
metrics_df_desap <- data.frame(
  Accuracy = unname(sapply(metrics_list, function(x) x["Accuracy"])),
  Sensitivity = sensitivity_list,
  Specificity = specificity_list,
  Pos_Pred_Value = pos_pred_value_list,
  Neg_Pred_Value = neg_pred_value_list,
  Balanced_Accuracy = balanced_accuracy_list
)

# Calcular la media de las métricas
mean_metrics_desap <- colMeans(metrics_df_desap)
mean_metrics_desap

```
Base de datos con observados e imputados: 

```{r}

agregados_comparacion_desap <- comparacion_desap %>%
  group_by(yy_hecho) %>%
  summarise(

  	estado_obs = sum(p_str_obs == "EST"),
    estado_donante1 = sum(p_str_donante1 == "EST"),
    estado_donante2 = sum(p_str_donante2 == "EST"),
    estado_donante3 = sum(p_str_donante3 == "EST"),
    estado_donante4 = sum(p_str_donante4 == "EST"),
    estado_donante5 = sum(p_str_donante5 == "EST"),
    
    eln_obs = sum(p_str_obs == "GUE-ELN"),
    eln_donante1 = sum(p_str_donante1 == "GUE-ELN"),
    eln_donante2 = sum(p_str_donante2 == "GUE-ELN"),
    eln_donante3 = sum(p_str_donante3 == "GUE-ELN"),
    eln_donante4 = sum(p_str_donante4 == "GUE-ELN"),
    eln_donante5 = sum(p_str_donante5 == "GUE-ELN"),
    
    farc_obs = sum(p_str_obs == "GUE-FARC"),
    farc_donante1 = sum(p_str_donante1 == "GUE-FARC"),
    farc_donante2 = sum(p_str_donante2 == "GUE-FARC"),
    farc_donante3 = sum(p_str_donante3 == "GUE-FARC"),
    farc_donante4 = sum(p_str_donante4 == "GUE-FARC"),
    farc_donante5 = sum(p_str_donante5 == "GUE-FARC"),
    
    gue_otro_obs = sum(p_str_obs == "GUE-OTRO"),
    gue_otro_donante1 = sum(p_str_donante1 == "GUE-OTRO"),
    gue_otro_donante2 = sum(p_str_donante2 == "GUE-OTRO"),
    gue_otro_donante3 = sum(p_str_donante3 == "GUE-OTRO"),
    gue_otro_donante4 = sum(p_str_donante4 == "GUE-OTRO"),
    gue_otro_donante5 = sum(p_str_donante5 == "GUE-OTRO"),
    
    multi_obs = sum(p_str_obs == "multiple"),
    multi_donante1 = sum(p_str_donante1 == "multiple"),
    multi_donante2 = sum(p_str_donante2 == "multiple"),
    multi_donante3 = sum(p_str_donante3 == "multiple"),
    multi_donante4 = sum(p_str_donante4 == "multiple"),
    multi_donante5 = sum(p_str_donante5 == "multiple"),
    
    otro_obs = sum(p_str_obs == "OTRO"),
    otro_donante1 = sum(p_str_donante1 == "OTRO"),
    otro_donante2 = sum(p_str_donante2 == "OTRO"),
    otro_donante3 = sum(p_str_donante3 == "OTRO"),
    otro_donante4 = sum(p_str_donante4 == "OTRO"),
    otro_donante5 = sum(p_str_donante5 == "OTRO"),
    
    para_obs = sum(p_str_obs == "PARA"),
    para_donante1 = sum(p_str_donante1 == "PARA"),
    para_donante2 = sum(p_str_donante2 == "PARA"),
    para_donante3 = sum(p_str_donante3 == "PARA"),
    para_donante4 = sum(p_str_donante4 == "PARA"),
    para_donante5 = sum(p_str_donante5 == "PARA"),

  ) %>%
  arrange(yy_hecho)
```


Calcular el impacto:
```{r}

# Impacto para Estado
impacto_estado_desap <- calcular_impacto(donante_cols_estado, observaciones_estado, agregados_comparacion_desap)

print(impacto_estado_desap$wai)
print(impacto_estado_desap$mean_wai) 
print(impacto_estado_desap$wrai)
print(impacto_estado_desap$mean_wrai) 

# Impacto para eln
impacto_eln_desap <- calcular_impacto(donante_cols_eln, observaciones_eln, agregados_comparacion_desap)

print(impacto_eln_desap$wai)
print(impacto_eln_desap$mean_wai) 
print(impacto_eln_desap$wrai)
print(impacto_eln_desap$mean_wrai) 

# Impacto para farc
impacto_farc_desap <- calcular_impacto(donante_cols_farc, observaciones_farc, agregados_comparacion_desap)

print(impacto_farc_desap$wai)
print(impacto_farc_desap$mean_wai) 
print(impacto_farc_desap$wrai)
print(impacto_farc_desap$mean_wrai) 

# Impacto para gue_otro
impacto_gue_otro_desap <- calcular_impacto(donante_cols_gue_otro, observaciones_gue_otro, agregados_comparacion_desap)

print(impacto_gue_otro_desap$wai)
print(impacto_gue_otro_desap$mean_wai) 
print(impacto_gue_otro_desap$wrai)
print(impacto_gue_otro_desap$mean_wrai) 

# Impacto para multi
impacto_multi_desap <- calcular_impacto(donante_cols_multi, observaciones_multi, agregados_comparacion_desap)

print(impacto_multi_desap$wai)
print(impacto_multi_desap$mean_wai) 
print(impacto_multi_desap$wrai)
print(impacto_multi_desap$mean_wrai) 

# Impacto para otro
impacto_otro_desap <- calcular_impacto(donante_cols_otro, observaciones_otro, agregados_comparacion_desap)

print(impacto_otro_desap$wai)
print(impacto_otro_desap$mean_wai) 
print(impacto_otro_desap$wrai)
print(impacto_otro_desap$mean_wrai) 

# Impacto para para
impacto_para_desap <- calcular_impacto(donante_cols_para, observaciones_para, agregados_comparacion_desap)

print(impacto_para_desap$wai)
print(impacto_para_desap$mean_wai) 
print(impacto_para_desap$wrai)
print(impacto_para_desap$mean_wrai) 
```

# Homicidio:

Se unen los datos reales a los datos imputados para cada uno de los grupos:
```{r}

artif_donante_p_str_homi1 <- (artif_donante_p_str_1[["homicidio_1998_2016"]])
artif_donante_p_str_homi2 <- (artif_donante_p_str_2[["homicidio_1998_2016"]])
artif_donante_p_str_homi3 <- (artif_donante_p_str_3[["homicidio_1998_2016"]])
artif_donante_p_str_homi4 <- (artif_donante_p_str_4[["homicidio_1998_2016"]])
artif_donante_p_str_homi5 <- (artif_donante_p_str_5[["homicidio_1998_2016"]])


comparacion_homi <- complete_violencias_unidas_aux %>%
	filter(violencia == "homicidio") %>%
	select(match_group_id, muni_code_hecho, yy_hecho, p_str) %>%
	mutate(p_str_obs = as.factor(p_str)) %>%
	select(-p_str) %>%
	merge(artif_donante_p_str_homi1, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante1 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_homi2, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante2 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_homi3, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante3 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_homi4, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante4 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_homi5, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante5 = as.factor(p_str_donante)) %>% select(-p_str_donante)

```

Matriz de confusión:

```{r}
# Columnas a comparar
donante_cols <- c("p_str_donante1", "p_str_donante2", "p_str_donante3", "p_str_donante4", "p_str_donante5")

metrics_list <- list()
sensitivity_list <- c()
specificity_list <- c()
pos_pred_value_list <- c()
neg_pred_value_list <- c()
balanced_accuracy_list <- c()

# Calcular matrices de confusión 
for (col in donante_cols) {
  conf_matrix <- confusionMatrix(comparacion_homi[[col]], comparacion_homi$p_str_obs)
  
  # Guardar métricas generales
  metrics_list[[col]] <- conf_matrix$overall
  
  # Guardar métricas específicas
  sensitivity_list <- c(sensitivity_list, conf_matrix$byClass[, "Sensitivity"])
  specificity_list <- c(specificity_list, conf_matrix$byClass[, "Specificity"])
  pos_pred_value_list <- c(pos_pred_value_list, conf_matrix$byClass[, "Pos Pred Value"])
  neg_pred_value_list <- c(neg_pred_value_list, conf_matrix$byClass[, "Neg Pred Value"])
  balanced_accuracy_list <- c(balanced_accuracy_list, conf_matrix$byClass[, "Balanced Accuracy"])

}

# Crear un data frame con las métricas de cada matriz de confusión
metrics_df_homi <- data.frame(
  Accuracy = unname(sapply(metrics_list, function(x) x["Accuracy"])),
  Sensitivity = sensitivity_list,
  Specificity = specificity_list,
  Pos_Pred_Value = pos_pred_value_list,
  Neg_Pred_Value = neg_pred_value_list,
  Balanced_Accuracy = balanced_accuracy_list
)

# Calcular la media de las métricas
mean_metrics_homi <- colMeans(metrics_df_homi)
mean_metrics_homi

```
Base de datos con observados e imputados: 

```{r}

agregados_comparacion_homi <- comparacion_homi %>%
  group_by(yy_hecho) %>%
  summarise(

  	estado_obs = sum(p_str_obs == "EST"),
    estado_donante1 = sum(p_str_donante1 == "EST"),
    estado_donante2 = sum(p_str_donante2 == "EST"),
    estado_donante3 = sum(p_str_donante3 == "EST"),
    estado_donante4 = sum(p_str_donante4 == "EST"),
    estado_donante5 = sum(p_str_donante5 == "EST"),
    
    eln_obs = sum(p_str_obs == "GUE-ELN"),
    eln_donante1 = sum(p_str_donante1 == "GUE-ELN"),
    eln_donante2 = sum(p_str_donante2 == "GUE-ELN"),
    eln_donante3 = sum(p_str_donante3 == "GUE-ELN"),
    eln_donante4 = sum(p_str_donante4 == "GUE-ELN"),
    eln_donante5 = sum(p_str_donante5 == "GUE-ELN"),
    
    farc_obs = sum(p_str_obs == "GUE-FARC"),
    farc_donante1 = sum(p_str_donante1 == "GUE-FARC"),
    farc_donante2 = sum(p_str_donante2 == "GUE-FARC"),
    farc_donante3 = sum(p_str_donante3 == "GUE-FARC"),
    farc_donante4 = sum(p_str_donante4 == "GUE-FARC"),
    farc_donante5 = sum(p_str_donante5 == "GUE-FARC"),
    
    gue_otro_obs = sum(p_str_obs == "GUE-OTRO"),
    gue_otro_donante1 = sum(p_str_donante1 == "GUE-OTRO"),
    gue_otro_donante2 = sum(p_str_donante2 == "GUE-OTRO"),
    gue_otro_donante3 = sum(p_str_donante3 == "GUE-OTRO"),
    gue_otro_donante4 = sum(p_str_donante4 == "GUE-OTRO"),
    gue_otro_donante5 = sum(p_str_donante5 == "GUE-OTRO"),
    
    multi_obs = sum(p_str_obs == "multiple"),
    multi_donante1 = sum(p_str_donante1 == "multiple"),
    multi_donante2 = sum(p_str_donante2 == "multiple"),
    multi_donante3 = sum(p_str_donante3 == "multiple"),
    multi_donante4 = sum(p_str_donante4 == "multiple"),
    multi_donante5 = sum(p_str_donante5 == "multiple"),
    
    otro_obs = sum(p_str_obs == "OTRO"),
    otro_donante1 = sum(p_str_donante1 == "OTRO"),
    otro_donante2 = sum(p_str_donante2 == "OTRO"),
    otro_donante3 = sum(p_str_donante3 == "OTRO"),
    otro_donante4 = sum(p_str_donante4 == "OTRO"),
    otro_donante5 = sum(p_str_donante5 == "OTRO"),
    
    para_obs = sum(p_str_obs == "PARA"),
    para_donante1 = sum(p_str_donante1 == "PARA"),
    para_donante2 = sum(p_str_donante2 == "PARA"),
    para_donante3 = sum(p_str_donante3 == "PARA"),
    para_donante4 = sum(p_str_donante4 == "PARA"),
    para_donante5 = sum(p_str_donante5 == "PARA"),

  ) %>%
  arrange(yy_hecho)
```


Calcular el impacto:
```{r}

# Impacto para Estado
impacto_estado_homi <- calcular_impacto(donante_cols_estado, observaciones_estado, agregados_comparacion_homi)

print(impacto_estado_homi$wai)
print(impacto_estado_homi$mean_wai) 
print(impacto_estado_homi$wrai)
print(impacto_estado_homi$mean_wrai) 

# Impacto para eln
impacto_eln_homi <- calcular_impacto(donante_cols_eln, observaciones_eln, agregados_comparacion_homi)

print(impacto_eln_homi$wai)
print(impacto_eln_homi$mean_wai) 
print(impacto_eln_homi$wrai)
print(impacto_eln_homi$mean_wrai) 

# Impacto para farc
impacto_farc_homi <- calcular_impacto(donante_cols_farc, observaciones_farc, agregados_comparacion_homi)

print(impacto_farc_homi$wai)
print(impacto_farc_homi$mean_wai) 
print(impacto_farc_homi$wrai)
print(impacto_farc_homi$mean_wrai) 

# Impacto para gue_otro
impacto_gue_otro_homi <- calcular_impacto(donante_cols_gue_otro, observaciones_gue_otro, agregados_comparacion_homi)

print(impacto_gue_otro_homi$wai)
print(impacto_gue_otro_homi$mean_wai) 
print(impacto_gue_otro_homi$wrai)
print(impacto_gue_otro_homi$mean_wrai) 

# Impacto para multi
impacto_multi_homi <- calcular_impacto(donante_cols_multi, observaciones_multi, agregados_comparacion_homi)

print(impacto_multi_homi$wai)
print(impacto_multi_homi$mean_wai) 
print(impacto_multi_homi$wrai)
print(impacto_multi_homi$mean_wrai) 

# Impacto para otro
impacto_otro_homi <- calcular_impacto(donante_cols_otro, observaciones_otro, agregados_comparacion_homi)

print(impacto_otro_homi$wai)
print(impacto_otro_homi$mean_wai) 
print(impacto_otro_homi$wrai)
print(impacto_otro_homi$mean_wrai) 

# Impacto para para
impacto_para_homi <- calcular_impacto(donante_cols_para, observaciones_para, agregados_comparacion_homi)

print(impacto_para_homi$wai)
print(impacto_para_homi$mean_wai) 
print(impacto_para_homi$wrai)
print(impacto_para_homi$mean_wrai) 
```

# Reclutamiento:

Se unen los datos reales a los datos imputados para cada uno de los grupos:
```{r}
# Reclutamiento

artif_donante_p_str_reclu1 <- (artif_donante_p_str_1[["reclutamiento_1998_2016"]])
artif_donante_p_str_reclu2 <- (artif_donante_p_str_2[["reclutamiento_1998_2016"]])
artif_donante_p_str_reclu3 <- (artif_donante_p_str_3[["reclutamiento_1998_2016"]])
artif_donante_p_str_reclu4 <- (artif_donante_p_str_4[["reclutamiento_1998_2016"]])
artif_donante_p_str_reclu5 <- (artif_donante_p_str_5[["reclutamiento_1998_2016"]])


comparacion_reclu <- complete_violencias_unidas_aux %>%
	filter(violencia == "reclutamiento") %>%
	select(match_group_id, muni_code_hecho, yy_hecho, p_str) %>%
	mutate(p_str_obs = as.factor(p_str)) %>%
	select(-p_str) %>%
	merge(artif_donante_p_str_reclu1, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante1 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_reclu2, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante2 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_reclu3, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante3 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_reclu4, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante4 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_reclu5, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante5 = as.factor(p_str_donante)) %>% select(-p_str_donante)

```

Matriz de confusión:

```{r}
# Columnas a comparar
donante_cols <- c("p_str_donante1", "p_str_donante2", "p_str_donante3", "p_str_donante4", "p_str_donante5")

metrics_list <- list()
sensitivity_list <- c()
specificity_list <- c()
pos_pred_value_list <- c()
neg_pred_value_list <- c()
balanced_accuracy_list <- c()

# Calcular matrices de confusión 
for (col in donante_cols) {
  conf_matrix <- confusionMatrix(comparacion_reclu[[col]], comparacion_reclu$p_str_obs)
  
  # Guardar métricas generales
  metrics_list[[col]] <- conf_matrix$overall
  
  # Guardar métricas específicas
  sensitivity_list <- c(sensitivity_list, conf_matrix$byClass[, "Sensitivity"])
  specificity_list <- c(specificity_list, conf_matrix$byClass[, "Specificity"])
  pos_pred_value_list <- c(pos_pred_value_list, conf_matrix$byClass[, "Pos Pred Value"])
  neg_pred_value_list <- c(neg_pred_value_list, conf_matrix$byClass[, "Neg Pred Value"])
  balanced_accuracy_list <- c(balanced_accuracy_list, conf_matrix$byClass[, "Balanced Accuracy"])

}

# Crear un data frame con las métricas de cada matriz de confusión
metrics_df_reclu <- data.frame(
  Accuracy = unname(sapply(metrics_list, function(x) x["Accuracy"])),
  Sensitivity = sensitivity_list,
  Specificity = specificity_list,
  Pos_Pred_Value = pos_pred_value_list,
  Neg_Pred_Value = neg_pred_value_list,
  Balanced_Accuracy = balanced_accuracy_list
)

# Calcular la media de las métricas
mean_metrics_reclu <- colMeans(metrics_df_reclu)
mean_metrics_reclu

```
Base de datos con observados e imputados: 

```{r}

agregados_comparacion_reclu <- comparacion_reclu %>%
  group_by(yy_hecho) %>%
  summarise(

  	estado_obs = sum(p_str_obs == "EST"),
    estado_donante1 = sum(p_str_donante1 == "EST"),
    estado_donante2 = sum(p_str_donante2 == "EST"),
    estado_donante3 = sum(p_str_donante3 == "EST"),
    estado_donante4 = sum(p_str_donante4 == "EST"),
    estado_donante5 = sum(p_str_donante5 == "EST"),
    
    eln_obs = sum(p_str_obs == "GUE-ELN"),
    eln_donante1 = sum(p_str_donante1 == "GUE-ELN"),
    eln_donante2 = sum(p_str_donante2 == "GUE-ELN"),
    eln_donante3 = sum(p_str_donante3 == "GUE-ELN"),
    eln_donante4 = sum(p_str_donante4 == "GUE-ELN"),
    eln_donante5 = sum(p_str_donante5 == "GUE-ELN"),
    
    farc_obs = sum(p_str_obs == "GUE-FARC"),
    farc_donante1 = sum(p_str_donante1 == "GUE-FARC"),
    farc_donante2 = sum(p_str_donante2 == "GUE-FARC"),
    farc_donante3 = sum(p_str_donante3 == "GUE-FARC"),
    farc_donante4 = sum(p_str_donante4 == "GUE-FARC"),
    farc_donante5 = sum(p_str_donante5 == "GUE-FARC"),
    
    gue_otro_obs = sum(p_str_obs == "GUE-OTRO"),
    gue_otro_donante1 = sum(p_str_donante1 == "GUE-OTRO"),
    gue_otro_donante2 = sum(p_str_donante2 == "GUE-OTRO"),
    gue_otro_donante3 = sum(p_str_donante3 == "GUE-OTRO"),
    gue_otro_donante4 = sum(p_str_donante4 == "GUE-OTRO"),
    gue_otro_donante5 = sum(p_str_donante5 == "GUE-OTRO"),
    
    multi_obs = sum(p_str_obs == "multiple"),
    multi_donante1 = sum(p_str_donante1 == "multiple"),
    multi_donante2 = sum(p_str_donante2 == "multiple"),
    multi_donante3 = sum(p_str_donante3 == "multiple"),
    multi_donante4 = sum(p_str_donante4 == "multiple"),
    multi_donante5 = sum(p_str_donante5 == "multiple"),
    
    otro_obs = sum(p_str_obs == "OTRO"),
    otro_donante1 = sum(p_str_donante1 == "OTRO"),
    otro_donante2 = sum(p_str_donante2 == "OTRO"),
    otro_donante3 = sum(p_str_donante3 == "OTRO"),
    otro_donante4 = sum(p_str_donante4 == "OTRO"),
    otro_donante5 = sum(p_str_donante5 == "OTRO"),
    
    para_obs = sum(p_str_obs == "PARA"),
    para_donante1 = sum(p_str_donante1 == "PARA"),
    para_donante2 = sum(p_str_donante2 == "PARA"),
    para_donante3 = sum(p_str_donante3 == "PARA"),
    para_donante4 = sum(p_str_donante4 == "PARA"),
    para_donante5 = sum(p_str_donante5 == "PARA"),

  ) %>%
  arrange(yy_hecho)
```


Calcular el impacto:
```{r}

# Impacto para Estado
impacto_estado_reclu <- calcular_impacto(donante_cols_estado, observaciones_estado, agregados_comparacion_reclu)

print(impacto_estado_reclu$wai)
print(impacto_estado_reclu$mean_wai) 
print(impacto_estado_reclu$wrai)
print(impacto_estado_reclu$mean_wrai) 

# Impacto para eln
impacto_eln_reclu <- calcular_impacto(donante_cols_eln, observaciones_eln, agregados_comparacion_reclu)

print(impacto_eln_reclu$wai)
print(impacto_eln_reclu$mean_wai) 
print(impacto_eln_reclu$wrai)
print(impacto_eln_reclu$mean_wrai) 

# Impacto para farc
impacto_farc_reclu <- calcular_impacto(donante_cols_farc, observaciones_farc, agregados_comparacion_reclu)

print(impacto_farc_reclu$wai)
print(impacto_farc_reclu$mean_wai) 
print(impacto_farc_reclu$wrai)
print(impacto_farc_reclu$mean_wrai) 

# Impacto para gue_otro
impacto_gue_otro_reclu <- calcular_impacto(donante_cols_gue_otro, observaciones_gue_otro, agregados_comparacion_reclu)

print(impacto_gue_otro_reclu$wai)
print(impacto_gue_otro_reclu$mean_wai) 
print(impacto_gue_otro_reclu$wrai)
print(impacto_gue_otro_reclu$mean_wrai) 

# Impacto para multi
impacto_multi_reclu <- calcular_impacto(donante_cols_multi, observaciones_multi, agregados_comparacion_reclu)

print(impacto_multi_reclu$wai)
print(impacto_multi_reclu$mean_wai) 
print(impacto_multi_reclu$wrai)
print(impacto_multi_reclu$mean_wrai) 

# Impacto para otro
impacto_otro_reclu <- calcular_impacto(donante_cols_otro, observaciones_otro, agregados_comparacion_reclu)

print(impacto_otro_reclu$wai)
print(impacto_otro_reclu$mean_wai) 
print(impacto_otro_reclu$wrai)
print(impacto_otro_reclu$mean_wrai) 

# Impacto para para
impacto_para_reclu <- calcular_impacto(donante_cols_para, observaciones_para, agregados_comparacion_reclu)

print(impacto_para_reclu$wai)
print(impacto_para_reclu$mean_wai) 
print(impacto_para_reclu$wrai)
print(impacto_para_reclu$mean_wrai) 
```

# Secuestro:

Se unen los datos reales a los datos imputados para cada uno de los grupos:
```{r}
# Secuestro

artif_donante_p_str_secue1 <- (artif_donante_p_str_1[["secuestro_1998_2016"]])
artif_donante_p_str_secue2 <- (artif_donante_p_str_2[["secuestro_1998_2016"]])
artif_donante_p_str_secue3 <- (artif_donante_p_str_3[["secuestro_1998_2016"]])
artif_donante_p_str_secue4 <- (artif_donante_p_str_4[["secuestro_1998_2016"]])
artif_donante_p_str_secue5 <- (artif_donante_p_str_5[["secuestro_1998_2016"]])


comparacion_secue <- complete_violencias_unidas_aux %>%
	filter(violencia == "secuestro") %>%
	select(match_group_id, muni_code_hecho, yy_hecho, p_str) %>%
	mutate(p_str_obs = as.factor(p_str)) %>%
	select(-p_str) %>%
	merge(artif_donante_p_str_secue1, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante1 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_secue2, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante2 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_secue3, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante3 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_secue4, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante4 = as.factor(p_str_donante)) %>% select(-p_str_donante) %>%
	merge(artif_donante_p_str_secue5, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(p_str_donante5 = as.factor(p_str_donante)) %>% select(-p_str_donante)

```

Matriz de confusión:

```{r}
# Columnas a comparar
donante_cols <- c("p_str_donante1", "p_str_donante2", "p_str_donante3", "p_str_donante4", "p_str_donante5")

metrics_list <- list()
sensitivity_list <- c()
specificity_list <- c()
pos_pred_value_list <- c()
neg_pred_value_list <- c()
balanced_accuracy_list <- c()

# Calcular matrices de confusión 
for (col in donante_cols) {
  conf_matrix <- confusionMatrix(comparacion_secue[[col]], comparacion_secue$p_str_obs)
  
  # Guardar métricas generales
  metrics_list[[col]] <- conf_matrix$overall
  
  # Guardar métricas específicas
  sensitivity_list <- c(sensitivity_list, conf_matrix$byClass[, "Sensitivity"])
  specificity_list <- c(specificity_list, conf_matrix$byClass[, "Specificity"])
  pos_pred_value_list <- c(pos_pred_value_list, conf_matrix$byClass[, "Pos Pred Value"])
  neg_pred_value_list <- c(neg_pred_value_list, conf_matrix$byClass[, "Neg Pred Value"])
  balanced_accuracy_list <- c(balanced_accuracy_list, conf_matrix$byClass[, "Balanced Accuracy"])

}

# Crear un data frame con las métricas de cada matriz de confusión
metrics_df_secue <- data.frame(
  Accuracy = unname(sapply(metrics_list, function(x) x["Accuracy"])),
  Sensitivity = sensitivity_list,
  Specificity = specificity_list,
  Pos_Pred_Value = pos_pred_value_list,
  Neg_Pred_Value = neg_pred_value_list,
  Balanced_Accuracy = balanced_accuracy_list
)

# Calcular la media de las métricas
mean_metrics_secue <- colMeans(metrics_df_secue)
mean_metrics_secue

```
Base de datos con observados e imputados: 

```{r}

agregados_comparacion_secue <- comparacion_secue %>%
  group_by(yy_hecho) %>%
  summarise(

  	estado_obs = sum(p_str_obs == "EST"),
    estado_donante1 = sum(p_str_donante1 == "EST"),
    estado_donante2 = sum(p_str_donante2 == "EST"),
    estado_donante3 = sum(p_str_donante3 == "EST"),
    estado_donante4 = sum(p_str_donante4 == "EST"),
    estado_donante5 = sum(p_str_donante5 == "EST"),
    
    eln_obs = sum(p_str_obs == "GUE-ELN"),
    eln_donante1 = sum(p_str_donante1 == "GUE-ELN"),
    eln_donante2 = sum(p_str_donante2 == "GUE-ELN"),
    eln_donante3 = sum(p_str_donante3 == "GUE-ELN"),
    eln_donante4 = sum(p_str_donante4 == "GUE-ELN"),
    eln_donante5 = sum(p_str_donante5 == "GUE-ELN"),
    
    farc_obs = sum(p_str_obs == "GUE-FARC"),
    farc_donante1 = sum(p_str_donante1 == "GUE-FARC"),
    farc_donante2 = sum(p_str_donante2 == "GUE-FARC"),
    farc_donante3 = sum(p_str_donante3 == "GUE-FARC"),
    farc_donante4 = sum(p_str_donante4 == "GUE-FARC"),
    farc_donante5 = sum(p_str_donante5 == "GUE-FARC"),
    
    gue_otro_obs = sum(p_str_obs == "GUE-OTRO"),
    gue_otro_donante1 = sum(p_str_donante1 == "GUE-OTRO"),
    gue_otro_donante2 = sum(p_str_donante2 == "GUE-OTRO"),
    gue_otro_donante3 = sum(p_str_donante3 == "GUE-OTRO"),
    gue_otro_donante4 = sum(p_str_donante4 == "GUE-OTRO"),
    gue_otro_donante5 = sum(p_str_donante5 == "GUE-OTRO"),
    
    multi_obs = sum(p_str_obs == "multiple"),
    multi_donante1 = sum(p_str_donante1 == "multiple"),
    multi_donante2 = sum(p_str_donante2 == "multiple"),
    multi_donante3 = sum(p_str_donante3 == "multiple"),
    multi_donante4 = sum(p_str_donante4 == "multiple"),
    multi_donante5 = sum(p_str_donante5 == "multiple"),
    
    otro_obs = sum(p_str_obs == "OTRO"),
    otro_donante1 = sum(p_str_donante1 == "OTRO"),
    otro_donante2 = sum(p_str_donante2 == "OTRO"),
    otro_donante3 = sum(p_str_donante3 == "OTRO"),
    otro_donante4 = sum(p_str_donante4 == "OTRO"),
    otro_donante5 = sum(p_str_donante5 == "OTRO"),
    
    para_obs = sum(p_str_obs == "PARA"),
    para_donante1 = sum(p_str_donante1 == "PARA"),
    para_donante2 = sum(p_str_donante2 == "PARA"),
    para_donante3 = sum(p_str_donante3 == "PARA"),
    para_donante4 = sum(p_str_donante4 == "PARA"),
    para_donante5 = sum(p_str_donante5 == "PARA"),

  ) %>%
  arrange(yy_hecho)
```


Calcular el impacto:
```{r}

# Impacto para Estado
impacto_estado_secue <- calcular_impacto(donante_cols_estado, observaciones_estado, agregados_comparacion_secue)

print(impacto_estado_secue$wai)
print(impacto_estado_secue$mean_wai) 
print(impacto_estado_secue$wrai)
print(impacto_estado_secue$mean_wrai) 

# Impacto para eln
impacto_eln_secue <- calcular_impacto(donante_cols_eln, observaciones_eln, agregados_comparacion_secue)

print(impacto_eln_secue$wai)
print(impacto_eln_secue$mean_wai) 
print(impacto_eln_secue$wrai)
print(impacto_eln_secue$mean_wrai) 

# Impacto para farc
impacto_farc_secue <- calcular_impacto(donante_cols_farc, observaciones_farc, agregados_comparacion_secue)

print(impacto_farc_secue$wai)
print(impacto_farc_secue$mean_wai) 
print(impacto_farc_secue$wrai)
print(impacto_farc_secue$mean_wrai) 

# Impacto para gue_otro
impacto_gue_otro_secue <- calcular_impacto(donante_cols_gue_otro, observaciones_gue_otro, agregados_comparacion_secue)

print(impacto_gue_otro_secue$wai)
print(impacto_gue_otro_secue$mean_wai) 
print(impacto_gue_otro_secue$wrai)
print(impacto_gue_otro_secue$mean_wrai) 

# Impacto para multi
impacto_multi_secue <- calcular_impacto(donante_cols_multi, observaciones_multi, agregados_comparacion_secue)

print(impacto_multi_secue$wai)
print(impacto_multi_secue$mean_wai) 
print(impacto_multi_secue$wrai)
print(impacto_multi_secue$mean_wrai) 

# Impacto para otro
impacto_otro_secue <- calcular_impacto(donante_cols_otro, observaciones_otro, agregados_comparacion_secue)

print(impacto_otro_secue$wai)
print(impacto_otro_secue$mean_wai) 
print(impacto_otro_secue$wrai)
print(impacto_otro_secue$mean_wrai) 

# Impacto para para
impacto_para_secue <- calcular_impacto(donante_cols_para, observaciones_para, agregados_comparacion_secue)

print(impacto_para_secue$wai)
print(impacto_para_secue$mean_wai) 
print(impacto_para_secue$wrai)
print(impacto_para_secue$mean_wrai) 
```


