---
title: "Contraste de métodos de imputación estadística en la documentación de víctimas del
conflicto armado colombiano"
author: "Valentina Gómez^[[valegome@ucm.es](valegome@ucm.es)]"
date: '`r format(Sys.time(), "%d %B %Y")`'
output: pdf_document
site: "bookdown::bookdown_site"
lang: es-CO
fig_width: 4
fig_height: 2.5
fontsize: 12pt
urlcolor: blue
editor_options: 
  markdown: 
    wrap: sentence
---
# Validación cruzada modelos - Edad

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(pacman)
p_load(here, readr, tidyverse, dplyr, validate, data.table, missForest, 
			 VIM, lattice, simputation, mice, skimr, compareDF, caret)

```

Importación de datos:

```{r}
input_dir <- here::here("06.union/output")
output_dir <- here::here("10.validacion_modelos/output/donante/edad_jep")

violencias_unidas_aux <- readRDS(paste0(input_dir,"/violencias_unidas_aux.rds")) %>%
	as.data.table()

colSums(is.na(violencias_unidas_aux))
dim(violencias_unidas_aux)

```

Me quedo con las observaciones que están completas:

```{r}
complete_violencias_unidas_aux<-violencias_unidas_aux[complete.cases(violencias_unidas_aux),]
dim(complete_violencias_unidas_aux)

rm(violencias_unidas_aux)
```

Divido la base de datos en 5 grupos del mismo tamaño de manera aletoria: 

```{r}
set.seed(123)

complete_violencias_unidas_aux <- complete_violencias_unidas_aux %>%
  group_by(violencia) %>%
  mutate(grupo = sample(rep(1:5, length.out = n())))

table(complete_violencias_unidas_aux$violencia, complete_violencias_unidas_aux$grupo)

```

Genero valores NA's para un grupo de cada violencia y dejo los otros 4 grupos como parte del entrenamiento: 

```{r}
violencias_artificial_nas_1 <- complete_violencias_unidas_aux %>%
	mutate(edad_jep = case_when(grupo == 1 ~ NA,
													TRUE ~ edad_jep))

table(violencias_artificial_nas_1$violencia, 
			violencias_artificial_nas_1$grupo,
			violencias_artificial_nas_1$edad_jep, useNA = "always")

#conteos de clase antes de la imputación
conteos_edad_jep_ant1 <- violencias_artificial_nas_1 %>%
	mutate(categoria = edad_jep) %>%
	group_by(categoria, violencia) %>%
	summarise(n_class= n()) %>%
	mutate(donante = "edad_jep_donante1") %>%
	ungroup() %>%
	group_by(violencia) %>%
	mutate(N = sum(n_class))

violencias_artificial_nas_2 <- complete_violencias_unidas_aux %>%
	mutate(edad_jep = case_when(grupo == 2 ~ NA,
													TRUE ~ edad_jep))

#conteos de clase antes de la imputación
conteos_edad_jep_ant2 <- violencias_artificial_nas_2 %>%
	mutate(categoria = edad_jep) %>%
	group_by(categoria, violencia) %>%
	summarise(n_class= n()) %>%
	mutate(donante = "edad_jep_donante2") %>%
	ungroup() %>%
	group_by(violencia) %>%
	mutate(N = sum(n_class))

violencias_artificial_nas_3 <- complete_violencias_unidas_aux %>%
	mutate(edad_jep = case_when(grupo == 3 ~ NA,
													TRUE ~ edad_jep))

#conteos de clase antes de la imputación
conteos_edad_jep_ant3 <- violencias_artificial_nas_3 %>%
	mutate(categoria = edad_jep) %>%
	group_by(categoria, violencia) %>%
	summarise(n_class= n()) %>%
	mutate(donante = "edad_jep_donante3") %>%
	ungroup() %>%
	group_by(violencia) %>%
	mutate(N = sum(n_class))

violencias_artificial_nas_4 <- complete_violencias_unidas_aux %>%
	mutate(edad_jep = case_when(grupo == 4 ~ NA,
													TRUE ~ edad_jep))

#conteos de clase antes de la imputación
conteos_edad_jep_ant4 <- violencias_artificial_nas_4 %>%
	mutate(categoria = edad_jep) %>%
	group_by(categoria, violencia) %>%
	summarise(n_class= n()) %>%
	mutate(donante = "edad_jep_donante4") %>%
	ungroup() %>%
	group_by(violencia) %>%
	mutate(N = sum(n_class))

violencias_artificial_nas_5 <- complete_violencias_unidas_aux %>%
	mutate(edad_jep = case_when(grupo == 5 ~ NA,
													TRUE ~ edad_jep))

#conteos de clase antes de la imputación
conteos_edad_jep_ant5 <- violencias_artificial_nas_5 %>%
	mutate(categoria = edad_jep) %>%
	group_by(categoria, violencia) %>%
	summarise(n_class= n()) %>%
	mutate(donante = "edad_jep_donante5") %>%
	ungroup() %>%
	group_by(violencia) %>%
	mutate(N = sum(n_class))

```

Se imputa por Donante por periodos de tiempo (usando la misma imputación que 08.modelos_imputacion). Se hace para cada grupo como test y el resto como training:

```{r}
# Función para el procesamiento de distintos tipos de violencia en un rango de años

procesar_violencia <- function(data, tipo_violencia, start_year, end_year) {
  violencia_filtrada <- data %>%
    filter(violencia == tipo_violencia,
           yy_hecho >= start_year & yy_hecho <= end_year) %>%
    select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
           discapital_mpio, predo_rural_mpio, areaoficialkm2_mpio,
           asistesc_depto, per_alfa_depto, alumn_total_depto,
    			 nac_mujeres_mpio, nac_hombres_mpio, defunciones_mpio,
    			 nac_mujeres_depto, nac_hombres_depto, tot_defunciones_depto,
           edad_jep)
  
  print(paste("NA counts for", tipo_violencia, "from", start_year, "to", end_year))
  print(colSums(is.na(violencia_filtrada)))
  

  violencia_imp <- violencia_filtrada  |>
    impute_knn(edad_jep  ~ yy_hecho + muni_code_hecho + dept_code_hecho +
                     discapital_mpio + predo_rural_mpio + areaoficialkm2_mpio +
                     asistesc_depto + per_alfa_depto + alumn_total_depto +
                     nac_mujeres_mpio + nac_hombres_mpio + defunciones_mpio +
    			           nac_mujeres_depto + nac_hombres_depto + tot_defunciones_depto,
               backend = 'VIM')
  
  print(paste("NA counts after imputation for", tipo_violencia, "from", start_year, "to", end_year))
  print(colSums(is.na(violencia_imp)))
  
  imputed_flags <- as.data.frame(is.na(violencia_filtrada) & !is.na(violencia_imp))
  
  violencia_imp$edad_jep_imputed <- imputed_flags$edad_jep
  
  result <- violencia_imp %>%
	select(match_group_id, muni_code_hecho, yy_hecho, edad_jep) %>%
	mutate(edad_jep_donante = edad_jep) %>%
	select(-edad_jep)
  
  return(result)
}

# Tipos de violencia a procesar
tipos_violencia <- c("desaparicion", "homicidio", "reclutamiento", "secuestro")

# Periodos de años a procesar
periodos <- list(
  c(1998, 2016)
)

# Lista para almacenar los resultados
artif_donante_edad_jep_1 <- list()
artif_donante_edad_jep_2 <- list()
artif_donante_edad_jep_3 <- list()
artif_donante_edad_jep_4 <- list()
artif_donante_edad_jep_5 <- list()

# Procesar cada combinación de tipo de violencia y periodo de años

# Grupo 1
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result1 <- procesar_violencia(violencias_artificial_nas_1, tipo, start_year, end_year)
    artif_donante_edad_jep_1[[paste(tipo, start_year, end_year, sep = "_")]] <- result1
  }
}

saveRDS(artif_donante_edad_jep_1, (paste0(output_dir,"/artif_donante_edad_jep_1.rds")))
rm(artif_donante_edad_jep_1, result1)

# Grupo 2
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result2 <- procesar_violencia(violencias_artificial_nas_2, tipo, start_year, end_year)
    artif_donante_edad_jep_2[[paste(tipo, start_year, end_year, sep = "_")]] <- result2
  }
}

saveRDS(artif_donante_edad_jep_2, (paste0(output_dir,"/artif_donante_edad_jep_2.rds")))
rm(artif_donante_edad_jep_2, result2)

# Grupo 3
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result3 <- procesar_violencia(violencias_artificial_nas_3, tipo, start_year, end_year)
    artif_donante_edad_jep_3[[paste(tipo, start_year, end_year, sep = "_")]] <- result3
  }
}

saveRDS(artif_donante_edad_jep_3, (paste0(output_dir,"/artif_donante_edad_jep_3.rds")))
rm(artif_donante_edad_jep_3, result3)

# Grupo 4
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result4 <- procesar_violencia(violencias_artificial_nas_4, tipo, start_year, end_year)
    artif_donante_edad_jep_4[[paste(tipo, start_year, end_year, sep = "_")]] <- result4
  }
}

saveRDS(artif_donante_edad_jep_4, (paste0(output_dir,"/artif_donante_edad_jep_4.rds")))
rm(artif_donante_edad_jep_4, result4)

# Grupo 5
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result5 <- procesar_violencia(violencias_artificial_nas_5, tipo, start_year, end_year)
    artif_donante_edad_jep_5[[paste(tipo, start_year, end_year, sep = "_")]] <- result5
  }
}

saveRDS(artif_donante_edad_jep_5, (paste0(output_dir,"/artif_donante_edad_jep_5.rds")))
rm(artif_donante_edad_jep_5, result5)

```
Importo los resultados guardados:

```{r}

artif_donante_edad_jep_1 <- readRDS(paste0(output_dir,"/artif_donante_edad_jep_1.rds"))
artif_donante_edad_jep_2 <- readRDS(paste0(output_dir,"/artif_donante_edad_jep_2.rds"))
artif_donante_edad_jep_3 <- readRDS(paste0(output_dir,"/artif_donante_edad_jep_3.rds"))
artif_donante_edad_jep_4 <- readRDS(paste0(output_dir,"/artif_donante_edad_jep_4.rds"))
artif_donante_edad_jep_5 <- readRDS(paste0(output_dir,"/artif_donante_edad_jep_5.rds"))

```

Funciones para hacer descriptivos: 

```{r}
# Para generar matriz de confusión
generate_cv_summary <- function(metrics_df) {
  metrics_dt <- as.data.table(metrics_df)
  summary_list <- list()
  clases <- unique(metrics_dt$Clase)
  
  for (clase in clases) {
    class_metrics_dt <- metrics_dt[Clase == clase]
    
    stats_summary <- data.table(
      Clase = clase,
      Metric = colnames(class_metrics_dt)[-(1:2)],  # Excluir las primeras dos columnas (Donante_Col y Clase)
      Min = paste0(sapply(class_metrics_dt[, -c("Donante_Col", "Clase"), with = FALSE], function(x) round(min(x, na.rm = TRUE) * 100, 2)), "%"),
      `1st_Qu.` = paste0(sapply(class_metrics_dt[, -c("Donante_Col", "Clase"), with = FALSE], function(x) round(quantile(x, 0.25, na.rm = TRUE) * 100, 2)), "%"),
      Median = paste0(sapply(class_metrics_dt[, -c("Donante_Col", "Clase"), with = FALSE], function(x) round(median(x, na.rm = TRUE) * 100, 2)), "%"),
      Mean = paste0(sapply(class_metrics_dt[, -c("Donante_Col", "Clase"), with = FALSE], function(x) round(mean(x, na.rm = TRUE) * 100, 2)), "%"),
      `3rd_Qu.` = paste0(sapply(class_metrics_dt[, -c("Donante_Col", "Clase"), with = FALSE], function(x) round(quantile(x, 0.75, na.rm = TRUE) * 100, 2)), "%"),
      Max = paste0(sapply(class_metrics_dt[, -c("Donante_Col", "Clase"), with = FALSE], function(x) round(max(x, na.rm = TRUE) * 100, 2)), "%"),
      SD = paste0(sapply(class_metrics_dt[, -c("Donante_Col", "Clase"), with = FALSE], function(x) round(sd(x, na.rm = TRUE) * 100, 2)), "%")
    )
    
    summary_list[[clase]] <- stats_summary
  }
  
  final_summary <- rbindlist(summary_list)
  
  return(final_summary)
}

# Para generar data con wai y wrai
comparison_data <- function(data) {
  results_list <- list()
  categorias_edad_jep <- unique(data$edad_jep_obs)
  for (categoria in categorias_edad_jep) {
    data_filtrada <- data[edad_jep_obs == categoria]
    
    for (i in 1:5) {
      donor_col <- paste0("edad_jep_donante", i)
      
      result <- data_filtrada[, .(
        iguales = sum(edad_jep_obs == get(donor_col), na.rm = TRUE),
        diferentes = sum(edad_jep_obs != get(donor_col), na.rm = TRUE),
        donante = donor_col 
      )]
      
      result[, categoria := categoria] 
      results_list[[paste0(categoria, "_", i)]] <- result
    }
  }
  
  final_result <- rbindlist(results_list)
  return(final_result)
}


# Para descriptivos de WAI y WRAI de los 5 folds y de cada clase
generate_indicators_summary_by_class <- function(data) {
  # Verificar que las columnas necesarias están presentes
  required_cols <- c("categoria", "wai", "wrai")
  if (!all(required_cols %in% colnames(data))) {
    stop("Faltan una o más columnas necesarias en los datos.")
  }
  
  # Convertir el data frame en data.table
  data_dt <- as.data.table(data)
  
  # Inicializar una lista para almacenar los resúmenes por edad_jep
  summary_list <- list()
  
  # Agrupar por edad_jep
  edad_jeps <- unique(data_dt$categoria)
  
  # Iterar sobre cada edad_jep
  for (edad_jep in edad_jeps) {
    # Filtrar los datos correspondientes a la edad_jep actual
    edad_jep_data <- data_dt[categoria == edad_jep]
    
    # Calcular el resumen estadístico para cada métrica dentro de esta edad_jep
    stats_summary <- data.table(
      edad_jep = edad_jep,
      Metric = c("wai", "wrai"),
      Min = c(
        paste0(round(min(edad_jep_data$wai, na.rm = TRUE) * 100, 2), "%"),
        paste0(round(min(edad_jep_data$wrai, na.rm = TRUE) * 100, 2), "%")
      ),
      `1st_Qu.` = c(
        paste0(round(quantile(edad_jep_data$wai, 0.25, na.rm = TRUE) * 100, 2), "%"),
        paste0(round(quantile(edad_jep_data$wrai, 0.25, na.rm = TRUE) * 100, 2), "%")
      ),
      Median = c(
        paste0(round(median(edad_jep_data$wai, na.rm = TRUE) * 100, 2), "%"),
        paste0(round(median(edad_jep_data$wrai, na.rm = TRUE) * 100, 2), "%")
      ),
      Mean = c(
        paste0(round(mean(edad_jep_data$wai, na.rm = TRUE) * 100, 2), "%"),
        paste0(round(mean(edad_jep_data$wrai, na.rm = TRUE) * 100, 2), "%")
      ),
      `3rd_Qu.` = c(
        paste0(round(quantile(edad_jep_data$wai, 0.75, na.rm = TRUE) * 100, 2), "%"),
        paste0(round(quantile(edad_jep_data$wrai, 0.75, na.rm = TRUE) * 100, 2), "%")
      ),
      Max = c(
        paste0(round(max(edad_jep_data$wai, na.rm = TRUE) * 100, 2), "%"),
        paste0(round(max(edad_jep_data$wrai, na.rm = TRUE) * 100, 2), "%")
      ),
      SD = c(
        paste0(round(sd(edad_jep_data$wai, na.rm = TRUE) * 100, 2), "%"),
        paste0(round(sd(edad_jep_data$wrai, na.rm = TRUE) * 100, 2), "%")
      )
    )
    
    # Agregar el resumen estadístico de esta edad_jep a la lista
    summary_list[[edad_jep]] <- stats_summary
  }
  
  # Combinar todos los resúmenes en un solo data.table
  final_summary <- rbindlist(summary_list)
  
  return(final_summary)
}

```


# Desaparición:

Se unen los datos reales a los datos imputados para cada uno de los grupos:
```{r}
# Desaparición

artif_donante_edad_jep_desap1 <- (artif_donante_edad_jep_1[["desaparicion_1998_2016"]])
artif_donante_edad_jep_desap2 <- (artif_donante_edad_jep_2[["desaparicion_1998_2016"]])
artif_donante_edad_jep_desap3 <- (artif_donante_edad_jep_3[["desaparicion_1998_2016"]])
artif_donante_edad_jep_desap4 <- (artif_donante_edad_jep_4[["desaparicion_1998_2016"]])
artif_donante_edad_jep_desap5 <- (artif_donante_edad_jep_5[["desaparicion_1998_2016"]])


comparacion_desap <- complete_violencias_unidas_aux %>%
	filter(violencia == "desaparicion") %>%
	select(match_group_id, muni_code_hecho, yy_hecho, edad_jep) %>%
	mutate(edad_jep_obs = as.factor(edad_jep)) %>%
	select(-edad_jep) %>%
	merge(artif_donante_edad_jep_desap1, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante1 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_desap2, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante2 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_desap3, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante3 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_desap4, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante4 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_desap5, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante5 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	as.data.table()

```

Matriz de confusión:

```{r}
# Columnas a comparar
donante_cols <- c("edad_jep_donante1", "edad_jep_donante2", "edad_jep_donante3", "edad_jep_donante4", "edad_jep_donante5")

# listas para guardar métricas
metrics_list <- list()

# Calcular matrices de confusión
for (col in donante_cols) {
  conf_matrix <- confusionMatrix(comparacion_desap[[col]], comparacion_desap$edad_jep_obs)
  
  # Extraer clases
  clases <- rownames(conf_matrix$byClass)
  
  # Crear un data frame temporal para guardar métricas con etiquetas de clase y con columna donante
  temp_df <- data.frame(
    Donante_Col = col,
    Clase = clases,
    Accuracy = rep(conf_matrix$overall["Accuracy"], length(clases)),
    Sensitivity = conf_matrix$byClass[, "Sensitivity"],
    Specificity = conf_matrix$byClass[, "Specificity"],
    Pos_Pred_Value = conf_matrix$byClass[, "Pos Pred Value"],
    Neg_Pred_Value = conf_matrix$byClass[, "Neg Pred Value"],
    Balanced_Accuracy = conf_matrix$byClass[, "Balanced Accuracy"]
  )
  
  # Agregar el data frame temporal a la lista
  metrics_list[[col]] <- temp_df
}

# Combinar todos los data frames en uno solo
metrics_df_desap <- do.call(rbind, metrics_list)


metrics_cv_desap <- generate_cv_summary(metrics_df_desap)
metrics_cv_desap

```

WAI y WRAI:
```{r}
comparison_desap_stat1 <- comparison_data(comparacion_desap) %>%
	filter(donante == "edad_jep_donante1") %>%
	mutate(violencia = "desaparicion") %>%
	left_join(conteos_edad_jep_ant1) 

comparison_desap_stat2 <- comparison_data(comparacion_desap) %>%
	filter(donante == "edad_jep_donante2") %>%
	mutate(violencia = "desaparicion") %>%
	left_join(conteos_edad_jep_ant2) 

comparison_desap_stat3 <- comparison_data(comparacion_desap) %>%
	filter(donante == "edad_jep_donante3") %>%
	mutate(violencia = "desaparicion") %>%
	left_join(conteos_edad_jep_ant3) 

comparison_desap_stat4 <- comparison_data(comparacion_desap) %>%
	filter(donante == "edad_jep_donante4") %>%
	mutate(violencia = "desaparicion") %>%
	left_join(conteos_edad_jep_ant4) 

comparison_desap_stat5 <- comparison_data(comparacion_desap) %>%
	filter(donante == "edad_jep_donante5") %>%
	mutate(violencia = "desaparicion") %>%
	left_join(conteos_edad_jep_ant5) 

comparison_desap_stat <- rbind(comparison_desap_stat1,comparison_desap_stat2,comparison_desap_stat3,
															 comparison_desap_stat4,comparison_desap_stat4) %>%
	mutate(wai = (diferentes/N),
				 wrai = (diferentes/n_class))

# Extraer estadísticos de los 5 folds
stats_summary_desap <- generate_indicators_summary_by_class(comparison_desap_stat)
stats_summary_desap

```


# Homicidio:

Se unen los datos reales a los datos imputados para cada uno de los grupos:
```{r}
# homicidio

artif_donante_edad_jep_homi1 <- (artif_donante_edad_jep_1[["homicidio_1998_2016"]])
artif_donante_edad_jep_homi2 <- (artif_donante_edad_jep_2[["homicidio_1998_2016"]])
artif_donante_edad_jep_homi3 <- (artif_donante_edad_jep_3[["homicidio_1998_2016"]])
artif_donante_edad_jep_homi4 <- (artif_donante_edad_jep_4[["homicidio_1998_2016"]])
artif_donante_edad_jep_homi5 <- (artif_donante_edad_jep_5[["homicidio_1998_2016"]])


comparacion_homi <- complete_violencias_unidas_aux %>%
	filter(violencia == "homicidio") %>%
	select(match_group_id, muni_code_hecho, yy_hecho, edad_jep) %>%
	mutate(edad_jep_obs = as.factor(edad_jep)) %>%
	select(-edad_jep) %>%
	merge(artif_donante_edad_jep_homi1, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante1 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_homi2, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante2 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_homi3, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante3 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_homi4, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante4 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_homi5, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante5 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	as.data.table()

```

Matriz de confusión:

```{r}
# Columnas a comparar
donante_cols <- c("edad_jep_donante1", "edad_jep_donante2", "edad_jep_donante3", "edad_jep_donante4", "edad_jep_donante5")

# listas para guardar métricas
metrics_list <- list()

# Calcular matrices de confusión
for (col in donante_cols) {
  conf_matrix <- confusionMatrix(comparacion_homi[[col]], comparacion_homi$edad_jep_obs)
  
  # Extraer clases
  clases <- rownames(conf_matrix$byClass)
  
  # Crear un data frame temporal para guardar métricas con etiquetas de clase y con columna donante
  temp_df <- data.frame(
    Donante_Col = col,
    Clase = clases,
    Accuracy = rep(conf_matrix$overall["Accuracy"], length(clases)),
    Sensitivity = conf_matrix$byClass[, "Sensitivity"],
    Specificity = conf_matrix$byClass[, "Specificity"],
    Pos_Pred_Value = conf_matrix$byClass[, "Pos Pred Value"],
    Neg_Pred_Value = conf_matrix$byClass[, "Neg Pred Value"],
    Balanced_Accuracy = conf_matrix$byClass[, "Balanced Accuracy"]
  )
  
  # Agregar el data frame temporal a la lista
  metrics_list[[col]] <- temp_df
}

# Combinar todos los data frames en uno solo
metrics_df_homi <- do.call(rbind, metrics_list)


metrics_cv_homi <- generate_cv_summary(metrics_df_homi)
metrics_cv_homi

```

WAI y WRAI:
```{r}
comparison_homi_stat1 <- comparison_data(comparacion_homi) %>%
	filter(donante == "edad_jep_donante1") %>%
	mutate(violencia = "homicidio") %>%
	left_join(conteos_edad_jep_ant1) 

comparison_homi_stat2 <- comparison_data(comparacion_homi) %>%
	filter(donante == "edad_jep_donante2") %>%
	mutate(violencia = "homicidio") %>%
	left_join(conteos_edad_jep_ant2) 

comparison_homi_stat3 <- comparison_data(comparacion_homi) %>%
	filter(donante == "edad_jep_donante3") %>%
	mutate(violencia = "homicidio") %>%
	left_join(conteos_edad_jep_ant3) 

comparison_homi_stat4 <- comparison_data(comparacion_homi) %>%
	filter(donante == "edad_jep_donante4") %>%
	mutate(violencia = "homicidio") %>%
	left_join(conteos_edad_jep_ant4) 

comparison_homi_stat5 <- comparison_data(comparacion_homi) %>%
	filter(donante == "edad_jep_donante5") %>%
	mutate(violencia = "homicidio") %>%
	left_join(conteos_edad_jep_ant5) 

comparison_homi_stat <- rbind(comparison_homi_stat1,comparison_homi_stat2,comparison_homi_stat3,
															 comparison_homi_stat4,comparison_homi_stat4) %>%
	mutate(wai = (diferentes/N),
				 wrai = (diferentes/n_class))

# Extraer estadísticos de los 5 folds
stats_summary_homi <- generate_indicators_summary_by_class(comparison_homi_stat)
stats_summary_homi

```


# Reclutamiento:

Se unen los datos reales a los datos imputados para cada uno de los grupos:
```{r}
# Reclutamiento

artif_donante_edad_jep_reclu1 <- (artif_donante_edad_jep_1[["reclutamiento_1998_2016"]])
artif_donante_edad_jep_reclu2 <- (artif_donante_edad_jep_2[["reclutamiento_1998_2016"]])
artif_donante_edad_jep_reclu3 <- (artif_donante_edad_jep_3[["reclutamiento_1998_2016"]])
artif_donante_edad_jep_reclu4 <- (artif_donante_edad_jep_4[["reclutamiento_1998_2016"]])
artif_donante_edad_jep_reclu5 <- (artif_donante_edad_jep_5[["reclutamiento_1998_2016"]])


comparacion_reclu <- complete_violencias_unidas_aux %>%
	filter(violencia == "reclutamiento") %>%
	select(match_group_id, muni_code_hecho, yy_hecho, edad_jep) %>%
	mutate(edad_jep_obs = as.factor(edad_jep)) %>%
	select(-edad_jep) %>%
	merge(artif_donante_edad_jep_reclu1, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante1 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_reclu2, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante2 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_reclu3, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante3 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_reclu4, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante4 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_reclu5, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante5 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	as.data.table()

```

Matriz de confusión:

```{r}
# Columnas a comparar
donante_cols <- c("edad_jep_donante1", "edad_jep_donante2", "edad_jep_donante3", "edad_jep_donante4", "edad_jep_donante5")

# listas para guardar métricas
metrics_list <- list()

# Calcular matrices de confusión
for (col in donante_cols) {
  conf_matrix <- confusionMatrix(comparacion_reclu[[col]], comparacion_reclu$edad_jep_obs)
  
  # Extraer clases
  clases <- rownames(conf_matrix$byClass)
  
  # Crear un data frame temporal para guardar métricas con etiquetas de clase y con columna donante
  temp_df <- data.frame(
    Donante_Col = col,
    Clase = clases,
    Accuracy = rep(conf_matrix$overall["Accuracy"], length(clases)),
    Sensitivity = conf_matrix$byClass[, "Sensitivity"],
    Specificity = conf_matrix$byClass[, "Specificity"],
    Pos_Pred_Value = conf_matrix$byClass[, "Pos Pred Value"],
    Neg_Pred_Value = conf_matrix$byClass[, "Neg Pred Value"],
    Balanced_Accuracy = conf_matrix$byClass[, "Balanced Accuracy"]
  )
  
  # Agregar el data frame temporal a la lista
  metrics_list[[col]] <- temp_df
}

# Combinar todos los data frames en uno solo
metrics_df_reclu <- do.call(rbind, metrics_list)


metrics_cv_reclu <- generate_cv_summary(metrics_df_reclu)
metrics_cv_reclu

```

WAI y WRAI:
```{r}
comparison_reclu_stat1 <- comparison_data(comparacion_reclu) %>%
	filter(donante == "edad_jep_donante1") %>%
	mutate(violencia = "reclutamiento") %>%
	left_join(conteos_edad_jep_ant1) 

comparison_reclu_stat2 <- comparison_data(comparacion_reclu) %>%
	filter(donante == "edad_jep_donante2") %>%
	mutate(violencia = "reclutamiento") %>%
	left_join(conteos_edad_jep_ant2) 

comparison_reclu_stat3 <- comparison_data(comparacion_reclu) %>%
	filter(donante == "edad_jep_donante3") %>%
	mutate(violencia = "reclutamiento") %>%
	left_join(conteos_edad_jep_ant3) 

comparison_reclu_stat4 <- comparison_data(comparacion_reclu) %>%
	filter(donante == "edad_jep_donante4") %>%
	mutate(violencia = "reclutamiento") %>%
	left_join(conteos_edad_jep_ant4) 

comparison_reclu_stat5 <- comparison_data(comparacion_reclu) %>%
	filter(donante == "edad_jep_donante5") %>%
	mutate(violencia = "reclutamiento") %>%
	left_join(conteos_edad_jep_ant5) 

comparison_reclu_stat <- rbind(comparison_reclu_stat1,comparison_reclu_stat2,comparison_reclu_stat3,
															 comparison_reclu_stat4,comparison_reclu_stat4) %>%
	mutate(wai = (diferentes/N),
				 wrai = (diferentes/n_class))

# Extraer estadísticos de los 5 folds
stats_summary_reclu <- generate_indicators_summary_by_class(comparison_reclu_stat)
stats_summary_reclu

```

# Secuestro:

Se unen los datos reales a los datos imputados para cada uno de los grupos:
```{r}
# Secuestro

artif_donante_edad_jep_secue1 <- (artif_donante_edad_jep_1[["secuestro_1998_2016"]])
artif_donante_edad_jep_secue2 <- (artif_donante_edad_jep_2[["secuestro_1998_2016"]])
artif_donante_edad_jep_secue3 <- (artif_donante_edad_jep_3[["secuestro_1998_2016"]])
artif_donante_edad_jep_secue4 <- (artif_donante_edad_jep_4[["secuestro_1998_2016"]])
artif_donante_edad_jep_secue5 <- (artif_donante_edad_jep_5[["secuestro_1998_2016"]])


comparacion_secue <- complete_violencias_unidas_aux %>%
	filter(violencia == "secuestro") %>%
	select(match_group_id, muni_code_hecho, yy_hecho, edad_jep) %>%
	mutate(edad_jep_obs = as.factor(edad_jep)) %>%
	select(-edad_jep) %>%
	merge(artif_donante_edad_jep_secue1, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante1 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_secue2, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante2 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_secue3, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante3 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_secue4, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante4 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	merge(artif_donante_edad_jep_secue5, by = c("match_group_id", "muni_code_hecho", "yy_hecho")) %>%
	mutate(edad_jep_donante5 = as.factor(edad_jep_donante)) %>% select(-edad_jep_donante) %>%
	as.data.table()

```

Matriz de confusión:

```{r}
# Columnas a comparar
donante_cols <- c("edad_jep_donante1", "edad_jep_donante2", "edad_jep_donante3", "edad_jep_donante4", "edad_jep_donante5")

# listas para guardar métricas
metrics_list <- list()

# Calcular matrices de confusión
for (col in donante_cols) {
  conf_matrix <- confusionMatrix(comparacion_secue[[col]], comparacion_secue$edad_jep_obs)
  
  # Extraer clases
  clases <- rownames(conf_matrix$byClass)
  
  # Crear un data frame temporal para guardar métricas con etiquetas de clase y con columna donante
  temp_df <- data.frame(
    Donante_Col = col,
    Clase = clases,
    Accuracy = rep(conf_matrix$overall["Accuracy"], length(clases)),
    Sensitivity = conf_matrix$byClass[, "Sensitivity"],
    Specificity = conf_matrix$byClass[, "Specificity"],
    Pos_Pred_Value = conf_matrix$byClass[, "Pos Pred Value"],
    Neg_Pred_Value = conf_matrix$byClass[, "Neg Pred Value"],
    Balanced_Accuracy = conf_matrix$byClass[, "Balanced Accuracy"]
  )
  
  # Agregar el data frame temporal a la lista
  metrics_list[[col]] <- temp_df
}

# Combinar todos los data frames en uno solo
metrics_df_secue <- do.call(rbind, metrics_list)


metrics_cv_secue <- generate_cv_summary(metrics_df_secue)
metrics_cv_secue

```

WAI y WRAI:
```{r}
comparison_secue_stat1 <- comparison_data(comparacion_secue) %>%
	filter(donante == "edad_jep_donante1") %>%
	mutate(violencia = "secuestro") %>%
	left_join(conteos_edad_jep_ant1) 

comparison_secue_stat2 <- comparison_data(comparacion_secue) %>%
	filter(donante == "edad_jep_donante2") %>%
	mutate(violencia = "secuestro") %>%
	left_join(conteos_edad_jep_ant2) 

comparison_secue_stat3 <- comparison_data(comparacion_secue) %>%
	filter(donante == "edad_jep_donante3") %>%
	mutate(violencia = "secuestro") %>%
	left_join(conteos_edad_jep_ant3) 

comparison_secue_stat4 <- comparison_data(comparacion_secue) %>%
	filter(donante == "edad_jep_donante4") %>%
	mutate(violencia = "secuestro") %>%
	left_join(conteos_edad_jep_ant4) 

comparison_secue_stat5 <- comparison_data(comparacion_secue) %>%
	filter(donante == "edad_jep_donante5") %>%
	mutate(violencia = "secuestro") %>%
	left_join(conteos_edad_jep_ant5) 

comparison_secue_stat <- rbind(comparison_secue_stat1,comparison_secue_stat2,comparison_secue_stat3,
															 comparison_secue_stat4,comparison_secue_stat4) %>%
	mutate(wai = (diferentes/N),
				 wrai = (diferentes/n_class))

# Extraer estadísticos de los 5 folds
stats_summary_secue <- generate_indicators_summary_by_class(comparison_secue_stat)
stats_summary_secue

```