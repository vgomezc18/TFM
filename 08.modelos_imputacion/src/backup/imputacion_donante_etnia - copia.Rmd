---
title: "Contraste de métodos de imputación estadística en la documentación de víctimas del
conflicto armado colombiano"
author: "Valentina Gómez^[[valegome@ucm.es](valegome@ucm.es)]"
date: '`r format(Sys.time(), "%d %B %Y")`'
output: pdf_document
site: "bookdown::bookdown_site"
lang: es-CO
fig_width: 4
fig_height: 2.5
fontsize: 12pt
urlcolor: blue
editor_options: 
  markdown: 
    wrap: sentence
---
# Imputación por donante KNN - Etnia

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(pacman)
p_load(here, readr, tidyverse, dplyr, validate, data.table, missForest, 
			 VIM, lattice, simputation, mice, skimr, compareDF)

```

Importación de datos:

```{r}
input_dir <- here::here("06.union/output")
output_dir <- here::here("07.modelos_imputacion/output")

violencias_unidas_aux <- readRDS(paste0(input_dir,"/violencias_unidas_aux.rds")) %>%
	as.data.table()

```

Se imputa por periodos de tiempo:


```{r}
# Función para el procesamiento de distintos tipos de violencia en un rango de años

procesar_violencia <- function(data, tipo_violencia, start_year, end_year) {
  violencia_filtrada <- data %>%
    filter(violencia == tipo_violencia,
           yy_hecho >= start_year & yy_hecho <= end_year) %>%
    select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
           discapital_mpio, predo_rural_mpio, areaoficialkm2_mpio,
           asistesc_depto, per_alfa_depto, alumn_total_depto,
           y_transf_depto, g_func_general_depto, etnia)
  
  print(paste("NA counts for", tipo_violencia, "from", start_year, "to", end_year))
  print(colSums(is.na(violencia_filtrada)))
  
  violencia_imp <- violencia_filtrada  |>
    impute_knn(etnia  ~ yy_hecho + muni_code_hecho + dept_code_hecho +
                     discapital_mpio + predo_rural_mpio + areaoficialkm2_mpio +
                     asistesc_depto + per_alfa_depto + alumn_total_depto +
                     y_transf_depto + g_func_general_depto,
               backend = 'VIM')
  
  print(paste("NA counts after imputation for", tipo_violencia, "from", start_year, "to", end_year))
  print(colSums(is.na(violencia_imp)))
  
  imputed_flags <- as.data.frame(is.na(violencia_filtrada) & !is.na(violencia_imp))
  
  violencia_imp$etnia_imputed <- imputed_flags$etnia
  
  result <- violencia_imp %>%
    group_by(etnia, yy_hecho) %>%
    summarise(imp_donante = n()) %>%
    arrange(yy_hecho)
  
  return(result)
}

# Tipos de violencia a procesar
tipos_violencia <- c("desaparicion", "homicidio", "reclutamiento", "secuestro")

# Periodos de años a procesar
periodos <- list(
  c(1996, 2000),
  c(2001, 2005),
  c(2006, 2010),
  c(2011, 2016)
)

# Lista para almacenar los resultados
resultados <- list()

# Procesar cada combinación de tipo de violencia y periodo de años
for (tipo in tipos_violencia) {
  for (periodo in periodos) {
    start_year <- periodo[1]
    end_year <- periodo[2]
    result <- procesar_violencia(violencias_unidas_aux, tipo, start_year, end_year)
    resultados[[paste(tipo, start_year, end_year, sep = "_")]] <- result
  }
}

# Acceder a los resultados
result_desap_imp96_00 <- resultados[["desaparicion_1996_2000"]]
result_desap_imp01_05 <- resultados[["desaparicion_2001_2005"]]
result_desap_imp06_10 <- resultados[["desaparicion_2006_2010"]]
result_desap_imp11_16 <- resultados[["desaparicion_2011_2016"]]

result_homi_imp96_00 <- resultados[["homicidio_1996_2000"]]
result_homi_imp01_05 <- resultados[["homicidio_2001_2005"]]
result_homi_imp06_10 <- resultados[["homicidio_2006_2010"]]
result_homi_imp11_16 <- resultados[["homicidio_2011_2016"]]

result_reclu_imp96_00 <- resultados[["reclutamiento_1996_2000"]]
result_reclu_imp01_05 <- resultados[["reclutamiento_2001_2005"]]
result_reclu_imp06_10 <- resultados[["reclutamiento_2006_2010"]]
result_reclu_imp11_16 <- resultados[["reclutamiento_2011_2016"]]

result_secue_imp96_00 <- resultados[["secuestro_1996_2000"]]
result_secue_imp01_05 <- resultados[["secuestro_2001_2005"]]
result_secue_imp06_10 <- resultados[["secuestro_2006_2010"]]
result_secue_imp11_16 <- resultados[["secuestro_2011_2016"]]

saveRDS(resultados, (paste0(output_dir,"/imputacion_donante_etnia.rds")))

```

Juntar las imputaciones por donante: (En estos moments estoy dejando por fuera
la del 93 al 95)

```{r}
result_desap_donante <- bind_rows(#desaparicion_imp93_95, 
	                                result_desap_imp96_00,
																	result_desap_imp01_05,
																	result_desap_imp06_10,
																	result_desap_imp11_16)
colSums(is.na(result_desap_donante))

result_homi_donante <- bind_rows(#desaparicion_imp93_95, 
	                                result_homi_imp96_00,
																	result_homi_imp01_05,
																	result_homi_imp06_10,
																	result_homi_imp11_16)



colSums(is.na(result_desap_donante))

saveRDS(desaparicion_imp, "./output/etnia_imp_desaparicion.rds")
saveRDS(result_desap_donante, "./output/result_etnia_donante_desaparicion.rds")

```



#--------------------------------------------------------
<!-- # 1993-1995 -->

<!-- ```{r} -->
<!-- desaparicion_93_95 <- violencias_unidas_aux %>% -->
<!-- 	filter(violencia == "desaparicion", -->
<!-- 				 yy_hecho >= "1993" & yy_hecho <= "1995")%>% -->
<!-- 	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho,  -->
<!-- 				 discapital, predo_rural, asistesc_modif, per_alfa_modif, etnia) -->


<!-- #Imputación Donante: Vecino más próximo -->
<!-- desaparicion_imp93_95 <- desaparicion_93_95  |> -->
<!--   impute_knn(etnia  ~ yy_hecho+muni_code_hecho+dept_code_hecho+discapital+predo_rural+asistesc_modif+per_alfa_modif, -->
<!--   					 backend = 'VIM') |> -->
<!--   impute_knn(etnia  ~ yy_hecho+muni_code_hecho+dept_code_hecho+discapital+predo_rural, -->
<!--   					 backend = 'VIM') |> -->
<!--   impute_knn(etnia  ~ yy_hecho+dept_code_hecho+discapital, -->
<!--   					 backend = 'VIM') |> -->
<!--   impute_knn(etnia  ~ yy_hecho+dept_code_hecho, -->
<!--   					 backend = 'VIM') -->

<!-- imputed_flags <- as.data.frame(is.na(desaparicion_93_95) & !is.na(desaparicion_imp93_95)) -->

<!-- desaparicion_imp93_95$etnia_imputed <- imputed_flags$etnia -->

<!-- colSums(is.na(desaparicion_93_95)) -->
<!-- colSums(is.na(desaparicion_imp93_95)) -->

<!-- result_desap_imp93_95 <- desaparicion_imp93_95 %>% -->
<!-- 	group_by(etnia, yy_hecho) %>% -->
<!-- 	summarise(imp_donante=n())%>% -->
<!-- 	arrange(yy_hecho) -->

<!-- ``` -->
#--------------------------------------------------------
# 1996-2000

```{r}
desaparicion_96_00 <- violencias_unidas_aux %>%
	filter(violencia == "desaparicion",
				 yy_hecho >= "1996" & yy_hecho <= "2000")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital_mpio, predo_rural_mpio, areaoficialkm2_mpio,
				 asistesc_depto, per_alfa_depto, alumn_total_depto,
				 y_transf_depto, g_func_general_depto, etnia)

colSums(is.na(desaparicion_96_00))

#Imputación Donante: Vecino más próximo
desaparicion_imp96_00 <- desaparicion_96_00  |>
  impute_knn(etnia  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital_mpio+predo_rural_mpio+areaoficialkm2_mpio+
  					 	asistesc_depto+per_alfa_depto+alumn_total_depto+
  					 	y_transf_depto+g_func_general_depto,
  					 backend = 'VIM') 

colSums(is.na(desaparicion_imp96_00))

imputed_flags <- as.data.frame(is.na(desaparicion_96_00) & !is.na(desaparicion_imp96_00))

desaparicion_imp96_00$etnia_imputed <- imputed_flags$etnia

result_desap_imp96_00 <- desaparicion_imp96_00 %>%
	group_by(etnia, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```
# 2001-2005

```{r}
desaparicion_01_05 <- violencias_unidas_aux %>%
	filter(violencia == "desaparicion",
				 yy_hecho >= "2001" & yy_hecho <= "2005")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, etnia)

colSums(is.na(desaparicion_01_05))

#Imputación Donante: Vecino más próximo
desaparicion_imp01_05 <- desaparicion_01_05  |>
  impute_knn(etnia  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general,
  					 backend = 'VIM') 

colSums(is.na(desaparicion_imp01_05))

imputed_flags <- as.data.frame(is.na(desaparicion_01_05) & !is.na(desaparicion_imp01_05))

desaparicion_imp01_05$etnia_imputed <- imputed_flags$etnia

result_desap_imp01_05 <- desaparicion_imp01_05 %>%
	group_by(etnia, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```

# 2006-2010

```{r}
desaparicion_06_10 <- violencias_unidas_aux %>%
	filter(violencia == "desaparicion",
				 yy_hecho >= "2006" & yy_hecho <= "2010")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, etnia)

colSums(is.na(desaparicion_06_10))

#Imputación Donante: Vecino más próximo
desaparicion_imp06_10 <- desaparicion_06_10  |>
  impute_knn(etnia  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general,
  					 backend = 'VIM') 

colSums(is.na(desaparicion_imp06_10))

imputed_flags <- as.data.frame(is.na(desaparicion_06_10) & !is.na(desaparicion_imp06_10))

desaparicion_imp06_10$etnia_imputed <- imputed_flags$etnia

result_desap_imp06_10 <- desaparicion_imp06_10 %>%
	group_by(etnia, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```

# 2011-2016

```{r}
desaparicion_11_16 <- violencias_unidas_aux %>%
	filter(violencia == "desaparicion",
				 yy_hecho >= "2011" & yy_hecho <= "2016")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, etnia)

colSums(is.na(desaparicion_11_16))

#Imputación Donante: Vecino más próximo
desaparicion_imp11_16 <- desaparicion_11_16  |>
  impute_knn(etnia  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general,
  					 backend = 'VIM') 

colSums(is.na(desaparicion_imp11_16))

imputed_flags <- as.data.frame(is.na(desaparicion_11_16) & !is.na(desaparicion_imp11_16))

desaparicion_imp11_16$etnia_imputed <- imputed_flags$etnia

result_desap_imp11_16 <- desaparicion_imp11_16 %>%
	group_by(etnia, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```
#--------------------------------------------------------

Juntar las imputaciones por donante: (En estos moments estoy dejando por fuera
la del 93 al 95)

```{r}
desaparicion_imp <- bind_rows(#desaparicion_imp93_95, 
	                                desaparicion_imp96_00,
																	desaparicion_imp01_05,desaparicion_imp06_10,
																	desaparicion_imp11_16)
colSums(is.na(desaparicion_imp))

result_desap_donante <- bind_rows(#result_desap_imp93_95, 
																	result_desap_imp96_00,
																	result_desap_imp01_05,result_desap_imp06_10,
																	result_desap_imp11_16)

colSums(is.na(result_desap_donante))

saveRDS(desaparicion_imp, "./output/etnia_imp_desaparicion.rds")
saveRDS(result_desap_donante, "./output/result_etnia_donante_desaparicion.rds")

```

Inserto los resultados de JEP-CEV-HRDAG:

```{r}
replicas_desaparicion <- verdata::read_replicates(here::here("verdata-parquet/desaparicion"),
                                           "desaparicion", c(1:10))

tabla_documentada_desaparicion <- verdata::summary_observed("desaparicion",
                                               replicas_desaparicion, 
                                               strata_vars = c("etnia","yy_hecho"),
                                               conflict_filter = TRUE,
																							 forced_dis_filter = TRUE,
                                               edad_minors_filter = FALSE,
                                               include_props = TRUE)


tabla_combinada_desaparicion <- verdata::combine_replicates("desaparicion",
                                                tabla_documentada_desaparicion,
                                                replicas_desaparicion, 
                                                strata_vars = c("etnia", "yy_hecho"),
                                                conflict_filter = TRUE,
                                                forced_dis_filter = TRUE,
                                                edad_minors_filter = FALSE,
                                                include_props = TRUE)


tabla_combinada_desaparicion <- tabla_combinada_desaparicion %>% 
  select(yy_hecho, etnia, observed, obs_prop_na, obs_prop, imp_lo, imp_mean, imp_hi,
         imp_lo_p, imp_mean_p, imp_hi_p ) %>%
	left_join(result_desap_donante)

#paged_table(tabla_combinada_desaparicion, options = list(rows.print = 10, cols.print = 5))

rm(replicas_desaparicion)
```


# Comparación de resultados mestizos

```{r}

mestizos_proyecto <- tabla_combinada_desaparicion %>%
	  filter(etnia == "MESTIZO",
	  			 yy_hecho >= 1993) %>%
    mutate(observed = as.numeric(observed)) %>% 
    arrange((yy_hecho))

plot_desap_mestizos_year_imp <- mestizos_proyecto %>%
    mutate(yy_hecho = as.numeric(yy_hecho)) %>% 
	  filter(yy_hecho >= 1996) %>%
    ggplot(aes(x = yy_hecho)) +
    geom_line(aes(y = observed, color = "Observado"),  size = 1) +
    geom_line(aes(y = imp_mean,  color = "Imputado JEP-CEV-HRDAG"), size = 1) +
	  geom_line(aes(y = imp_donante,  color = "Imputado por Donante"), size = 1) +
	  geom_ribbon(aes(ymin = imp_lo,
                    ymax = imp_hi),
	  						fill = "#1F74B1",
                alpha = 0.2) +
    theme_minimal() +
    theme(axis.text.x = element_text(size = 11, angle = 90),
        axis.title.y = element_text(size = 11),
        axis.ticks.x = element_line(size = 0.1)) +
    scale_x_continuous(breaks = seq(1980, 2016, 2)) +
    theme(legend.position = "bottom") +
    labs(x = "Año",
         y = "Número de víctimas mestizas",
         color = "") +
    scale_colour_manual(values = c("Imputado JEP-CEV-HRDAG" = "#1F74B1", 
                               "Observado" = "#434343",
    															 "Imputado por Donante" = "red"))

plot_desap_mestizos_year_imp

ggsave("./output/plot_desap_mestizos_year_imp.jpg",
			 plot_desap_mestizos_year_imp)
```
# Comparación de resultados indígenas

```{r}

indigenas_proyecto <- tabla_combinada_desaparicion %>%
	  filter(etnia == "INDIGENA",
	  			 yy_hecho >= 1993) %>%
    mutate(observed = as.numeric(observed)) %>% 
    arrange((yy_hecho))


plot_desap_indigenas_year_imp <- indigenas_proyecto %>%
    mutate(yy_hecho = as.numeric(yy_hecho)) %>% 
   filter(yy_hecho >= 1996) %>%
    ggplot(aes(x = yy_hecho)) +
    geom_line(aes(y = observed, color = "Observado"),  size = 1) +
    geom_line(aes(y = imp_mean,  color = "Imputado JEP-CEV-HRDAG"), size = 1) +
	  geom_line(aes(y = imp_donante,  color = "Imputado por Donante"), size = 1) +
   	geom_ribbon(aes(ymin = imp_lo,
                    ymax = imp_hi),
	  						fill = "#1F74B1",
                alpha = 0.2) +
    theme_minimal() +
    theme(axis.text.x = element_text(size = 11, angle = 90),
        axis.title.y = element_text(size = 11),
        axis.ticks.x = element_line(size = 0.1)) +
    scale_x_continuous(breaks = seq(1980, 2016, 2)) +
    theme(legend.position = "bottom") +
    labs(x = "Año",
         y = "Número de víctimas indígenas",
         color = "") +
    scale_colour_manual(values = c("Imputado JEP-CEV-HRDAG" = "#1F74B1", 
                               "Observado" = "#434343",
    															 "Imputado por Donante" = "red"))

plot_desap_indigenas_year_imp

ggsave("./output/plot_desap_indigenas_year_imp.jpg",
			 plot_desap_indigenas_year_imp)
```
# Comparación de resultados NARP

```{r}

narp_proyecto <- tabla_combinada_desaparicion %>%
	  filter(etnia == "NARP",
	  			 yy_hecho >= 1993) %>%
    mutate(observed = as.numeric(observed)) %>% 
    arrange((yy_hecho))


plot_desap_narp_year_imp <- narp_proyecto %>%
    mutate(yy_hecho = as.numeric(yy_hecho)) %>%
	 filter(yy_hecho >= 1996) %>%
    ggplot(aes(x = yy_hecho)) +
    geom_line(aes(y = observed, color = "Observado"),  size = 1) +
    geom_line(aes(y = imp_mean,  color = "Imputado JEP-CEV-HRDAG"), size = 1) +
	  geom_line(aes(y = imp_donante,  color = "Imputado por Donante"), size = 1) +
	  geom_ribbon(aes(ymin = imp_lo,
                    ymax = imp_hi),
	  						fill = "#1F74B1",
                alpha = 0.2) +
    theme_minimal() +
    theme(axis.text.x = element_text(size = 11, angle = 90),
        axis.title.y = element_text(size = 11),
        axis.ticks.x = element_line(size = 0.1)) +
    scale_x_continuous(breaks = seq(1980, 2016, 2)) +
    theme(legend.position = "bottom") +
    labs(x = "Año",
         y = "Número de víctimas NARP",
         color = "") +
    scale_colour_manual(values = c("Imputado JEP-CEV-HRDAG" = "#1F74B1", 
                               "Observado" = "#434343",
    															 "Imputado por Donante" = "red"))

plot_desap_narp_year_imp

ggsave("./output/plot_desap_narp_year_imp.jpg",
			 plot_desap_narp_year_imp)
```


# Comparación de resultados RROM

```{r}

rrom_proyecto <- tabla_combinada_desaparicion %>%
	  filter(etnia == "ROM",
	  			 yy_hecho >= 1993) %>%
    mutate(observed = as.numeric(observed)) %>% 
    arrange((yy_hecho))


plot_desap_rrom_year_imp <- rrom_proyecto %>%
    mutate(yy_hecho = as.numeric(yy_hecho)) %>% 
  	filter(yy_hecho >= 1996) %>%
    ggplot(aes(x = yy_hecho)) +
    geom_line(aes(y = observed, color = "Observado"),  size = 1) +
    geom_line(aes(y = imp_mean,  color = "Imputado JEP-CEV-HRDAG"), size = 1) +
	  geom_line(aes(y = imp_donante,  color = "Imputado por Donante"), size = 1,
	  					linetype = "dashed") +
	  geom_ribbon(aes(ymin = imp_lo_p,
                    ymax = imp_hi),
	  						fill = "#1F74B1",
                alpha = 0.2) +
    theme_minimal() +
    theme(axis.text.x = element_text(size = 11, angle = 90),
        axis.title.y = element_text(size = 11),
        axis.ticks.x = element_line(size = 0.1)) +
    scale_x_continuous(breaks = seq(1980, 2016, 2)) +
    theme(legend.position = "bottom") +
    labs(x = "Año",
         y = "Número de víctimas Rrom",
         color = "") +
    scale_colour_manual(values = c("Observado" = "#434343",
    															 "Imputado JEP-CEV-HRDAG" = "#1F74B1",
    															"Imputado por Donante" = "red"))

plot_desap_rrom_year_imp

ggsave("./output/plot_desap_rrom_year_imp.jpg",
			 plot_desap_rrom_year_imp)
```

## 1.2 Desaparición - Perpetrador


## 2. Perpetrador 
# 2.1 Desaparición

# 1996-2000

```{r}
perp_96_00 <- violencias_unidas_aux %>%
	filter(violencia == "desaparicion",
				 yy_hecho >= "1996" & yy_hecho <= "2000")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, 
				 h_coca_inform, frontera, p_str)

colSums(is.na(perp_96_00))

#Imputación Donante: Vecino más próximo
perp_imp96_00 <- perp_96_00  |>
  impute_knn(p_str  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general+
  					 	h_coca_inform+frontera,
  					 backend = 'VIM') 

colSums(is.na(perp_imp96_00))

imputed_flags <- as.data.frame(is.na(perp_96_00) & !is.na(perp_imp96_00))

perp_imp96_00$p_str_imputed <- imputed_flags$p_str

result_perp_imp96_00 <- perp_imp96_00 %>%
	group_by(p_str, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```

# 2001-2005

```{r}
perp_01_05 <- violencias_unidas_aux %>%
	filter(violencia == "desaparicion",
				 yy_hecho >= "2001" & yy_hecho <= "2005")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, 
				 h_coca_inform, frontera, p_str)

colSums(is.na(perp_01_05))

#Imputación Donante: Vecino más próximo
perp_imp01_05 <- perp_01_05  |>
  impute_knn(p_str  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general+
  					 	h_coca_inform+frontera,
  					 backend = 'VIM') 

colSums(is.na(perp_imp01_05))

imputed_flags <- as.data.frame(is.na(perp_01_05) & !is.na(perp_imp01_05))

perp_imp01_05$p_str_imputed <- imputed_flags$p_str

result_perp_imp01_05 <- perp_imp01_05 %>%
	group_by(p_str, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```

# 2006-2010

```{r}
perp_06_10 <- violencias_unidas_aux %>%
	filter(violencia == "desaparicion",
				 yy_hecho >= "2006" & yy_hecho <= "2010")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, 
				 h_coca_inform, frontera, p_str)

colSums(is.na(perp_06_10))

#Imputación Donante: Vecino más próximo
perp_imp06_10 <- perp_06_10  |>
  impute_knn(p_str  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general+
  					 	h_coca_inform+frontera,
  					 backend = 'VIM') 

colSums(is.na(perp_imp06_10))

imputed_flags <- as.data.frame(is.na(perp_06_10) & !is.na(perp_imp06_10))

perp_imp06_10$p_str_imputed <- imputed_flags$p_str

result_perp_imp06_10 <- perp_imp06_10 %>%
	group_by(p_str, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```

# 2011-2016

```{r}
perp_11_16 <- violencias_unidas_aux %>%
	filter(violencia == "desaparicion",
				 yy_hecho >= "2011" & yy_hecho <= "2016")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, 
				 h_coca_inform, frontera, p_str)

colSums(is.na(perp_11_16))

#Imputación Donante: Vecino más próximo
perp_imp11_16 <- perp_11_16  |>
  impute_knn(p_str  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general+
  					 	h_coca_inform+frontera,
  					 backend = 'VIM') 

colSums(is.na(perp_imp11_16))

imputed_flags <- as.data.frame(is.na(perp_11_16) & !is.na(perp_imp11_16))

perp_imp11_16$p_str_imputed <- imputed_flags$p_str

result_perp_imp11_16 <- perp_imp11_16 %>%
	group_by(p_str, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```

Juntar las imputaciones por donante: 

```{r}
perp_imp <- bind_rows(#perp_imp93_95, 
	                                perp_imp96_00,
																	perp_imp01_05,perp_imp06_10,
																	perp_imp11_16)
colSums(is.na(perp_imp))

result_perp_donante <- bind_rows(#result_perp_imp93_95, 
																	result_perp_imp96_00,
																	result_perp_imp01_05,result_perp_imp06_10,
																	result_perp_imp11_16) %>%
	ungroup()%>%
	group_by(p_str)%>%
	summarize(imp_donante=sum(imp_donante))

colSums(is.na(result_perp_donante))

saveRDS(perp_imp, "./output/perp_imp_desaparicion.rds")
saveRDS(result_perp_donante, "./output/result_perp_donante_desaparicion.rds")

```
Inserto los resultados de JEP-CEV-HRDAG:

```{r}
replicas_desaparicion <- verdata::read_replicates(here::here("verdata-parquet/desaparicion"),
                                           "desaparicion", c(1:10))

tabla_documentada_perp <- verdata::summary_observed("desaparicion",
                                               replicas_desaparicion, 
                                               strata_vars = "p_str",
                                               conflict_filter = TRUE,
                                               forced_dis_filter = TRUE,
                                               edad_minors_filter = FALSE,
                                               include_props = TRUE)

tabla_combinada_perp <- verdata::combine_replicates("desaparicion",
                                                tabla_documentada_perp,
                                                replicas_desaparicion, 
                                                strata_vars = "p_str",
                                                conflict_filter = TRUE,
                                                forced_dis_filter = TRUE,
                                                edad_minors_filter = FALSE,
                                                include_props = TRUE)

tabla_combinada_perp <- tabla_combinada_perp %>% 
  select(p_str, observed, obs_prop_na, obs_prop, imp_lo, imp_mean, imp_hi,
         imp_lo_p, imp_mean_p, imp_hi_p )%>%
	left_join(result_perp_donante)

#paged_table(tabla_combinada_desaparicion, options = list(rows.print = 10, cols.print = 5))

rm(replicas_desaparicion)
```


#Comparación de resultados perpetrador

```{r}

plot_desap_perp_imp <- ggplot(tabla_combinada_perp,
                aes(x = reorder(p_str, -observed), y = 0)) +
  geom_crossbar(aes(ymin = imp_lo, ymax = imp_hi, fill = "Rango de imputación JEP-CEV-HRDAG"),
                color = "#1F74B1") +
  geom_col(aes(y = observed, fill = "Observado"), color = "#2F2F2F") +
  geom_point(aes(y = imp_mean), pch = 21, color = '#63aee3', fill = "#1F74B1",
             size = 1, stroke = 1.1) +
	geom_point(aes(y = imp_donante, fill = "Imputado por donante"), pch = 21, 
						 color = "red",
             size = 1, stroke = 1.1, show.legend = FALSE) +
  scale_y_continuous(labels = function(n){format(n, scientific = FALSE)}) +
  theme_minimal() +
  theme(legend.title = element_text(size = 6, face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.position = c(0.7, 0.7)) +
  theme(axis.text.x = element_text(angle = 50, hjust = 1, face = "bold")) +
  theme(legend.position = "top") +
  labs(x = "Perpetradores",
       y = "Número de víctimas",
       fill = "") +
  scale_fill_manual(values = c("Observado" = "#2F2F2F",
                               "Rango de imputación JEP-CEV-HRDAG" = "#1F74B1",
  														 "Imputado por donante" = "red"))

plot_desap_perp_imp


ggsave("./output/plot_desap_perp_imp.jpg",
			 plot_desap_perp_imp)
```


# 2.2 Homicidio

# 1996-2000

```{r}
perp_96_00 <- violencias_unidas_aux %>%
	filter(violencia == "homicidio",
				 yy_hecho >= "1996" & yy_hecho <= "2000")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, 
				 h_coca_inform, frontera, p_str)

colSums(is.na(perp_96_00))

#Imputación Donante: Vecino más próximo
perp_imp96_00 <- perp_96_00  |>
  impute_knn(p_str  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general+
  					 	h_coca_inform+frontera,
  					 backend = 'VIM') 

colSums(is.na(perp_imp96_00))

imputed_flags <- as.data.frame(is.na(perp_96_00) & !is.na(perp_imp96_00))

perp_imp96_00$p_str_imputed <- imputed_flags$p_str

result_perp_imp96_00 <- perp_imp96_00 %>%
	group_by(p_str, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```

# 2001-2005

```{r}
perp_01_05 <- violencias_unidas_aux %>%
	filter(violencia == "homicidio",
				 yy_hecho >= "2001" & yy_hecho <= "2005")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, 
				 h_coca_inform, frontera, p_str)

colSums(is.na(perp_01_05))

#Imputación Donante: Vecino más próximo
perp_imp01_05 <- perp_01_05  |>
  impute_knn(p_str  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general+
  					 	h_coca_inform+frontera,
  					 backend = 'VIM') 

colSums(is.na(perp_imp01_05))

imputed_flags <- as.data.frame(is.na(perp_01_05) & !is.na(perp_imp01_05))

perp_imp01_05$p_str_imputed <- imputed_flags$p_str

result_perp_imp01_05 <- perp_imp01_05 %>%
	group_by(p_str, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```

# 2006-2010

```{r}
perp_06_10 <- violencias_unidas_aux %>%
	filter(violencia == "homicidio",
				 yy_hecho >= "2006" & yy_hecho <= "2010")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, 
				 h_coca_inform, frontera, p_str)

colSums(is.na(perp_06_10))

#Imputación Donante: Vecino más próximo
perp_imp06_10 <- perp_06_10  |>
  impute_knn(p_str  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general+
  					 	h_coca_inform+frontera,
  					 backend = 'VIM') 

colSums(is.na(perp_imp06_10))

imputed_flags <- as.data.frame(is.na(perp_06_10) & !is.na(perp_imp06_10))

perp_imp06_10$p_str_imputed <- imputed_flags$p_str

result_perp_imp06_10 <- perp_imp06_10 %>%
	group_by(p_str, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```

# 2011-2016

```{r}
perp_11_16 <- violencias_unidas_aux %>%
	filter(violencia == "homicidio",
				 yy_hecho >= "2011" & yy_hecho <= "2016")%>%
	select(match_group_id, yy_hecho, muni_code_hecho, dept_code_hecho, 
				 discapital, predo_rural, areaoficialkm2,
				 asistesc_modif, per_alfa_modif, alumn_total,
				 y_transf, g_func_general, 
				 h_coca_inform, frontera, p_str)

colSums(is.na(perp_11_16))

#Imputación Donante: Vecino más próximo
perp_imp11_16 <- perp_11_16  |>
  impute_knn(p_str  ~ yy_hecho+muni_code_hecho+dept_code_hecho+
  					 	discapital+predo_rural+areaoficialkm2+
  					 	asistesc_modif+per_alfa_modif+alumn_total+
  					 	y_transf+g_func_general+
  					 	h_coca_inform+frontera,
  					 backend = 'VIM') 

colSums(is.na(perp_imp11_16))

imputed_flags <- as.data.frame(is.na(perp_11_16) & !is.na(perp_imp11_16))

perp_imp11_16$p_str_imputed <- imputed_flags$p_str

result_perp_imp11_16 <- perp_imp11_16 %>%
	group_by(p_str, yy_hecho) %>%
	summarise(imp_donante=n())%>%
	arrange(yy_hecho)

```

Juntar las imputaciones por donante: 

```{r}
perp_imp <- bind_rows(#perp_imp93_95, 
	                                perp_imp96_00,
																	perp_imp01_05,perp_imp06_10,
																	perp_imp11_16)
colSums(is.na(perp_imp))

result_perp_donante <- bind_rows(#result_perp_imp93_95, 
																	result_perp_imp96_00,
																	result_perp_imp01_05,result_perp_imp06_10,
																	result_perp_imp11_16) %>%
	ungroup()%>%
	group_by(p_str)%>%
	summarize(imp_donante=sum(imp_donante))

colSums(is.na(result_perp_donante))

saveRDS(perp_imp, "./output/perp_imp_homicidio.rds")
saveRDS(result_perp_donante, "./output/result_perp_donante_homicidio.rds")


```
Inserto los resultados de JEP-CEV-HRDAG:

```{r}
replicas_homicidio <- verdata::read_replicates(here::here("verdata-parquet/homicidio"),
                                           "homicidio", c(1:10))

tabla_documentada_perp <- verdata::summary_observed("homicidio",
                                               replicas_homicidio, 
                                               strata_vars = "p_str",
                                               conflict_filter = TRUE,
                                               forced_dis_filter = TRUE,
                                               edad_minors_filter = FALSE,
                                               include_props = TRUE)

tabla_combinada_perp <- verdata::combine_replicates("homicidio",
                                                tabla_documentada_perp,
                                                replicas_homicidio, 
                                                strata_vars = "p_str",
                                                conflict_filter = TRUE,
                                                forced_dis_filter = TRUE,
                                                edad_minors_filter = FALSE,
                                                include_props = TRUE)

tabla_combinada_perp <- tabla_combinada_perp %>% 
  select(p_str, observed, obs_prop_na, obs_prop, imp_lo, imp_mean, imp_hi,
         imp_lo_p, imp_mean_p, imp_hi_p )%>%
	left_join(result_perp_donante)

#paged_table(tabla_combinada_homicidio, options = list(rows.print = 10, cols.print = 5))

rm(replicas_homicidio)
```


#Comparación de resultados perpetrador

```{r}

plot_homi_perp_imp <- ggplot(tabla_combinada_perp,
                aes(x = reorder(p_str, -observed), y = 0)) +
  geom_crossbar(aes(ymin = imp_lo, ymax = imp_hi, fill = "Rango de imputación JEP-CEV-HRDAG"),
                color = "#1F74B1") +
  geom_col(aes(y = observed, fill = "Observado"), color = "#2F2F2F") +
  geom_point(aes(y = imp_mean), pch = 21, color = '#63aee3', fill = "#1F74B1",
             size = 1, stroke = 1.1) +
	geom_point(aes(y = imp_donante, fill = "Imputado por donante"), pch = 21, 
						 color = "red",
             size = 1, stroke = 1.1, show.legend = FALSE) +
  scale_y_continuous(labels = function(n){format(n, scientific = FALSE)}) +
  theme_minimal() +
  theme(legend.title = element_text(size = 6, face = "bold"),
        legend.text = element_text(size = 9, face = "bold"),
        legend.position = c(0.7, 0.7)) +
  theme(axis.text.x = element_text(angle = 50, hjust = 1, face = "bold")) +
  theme(legend.position = "top") +
  labs(x = "Perpetradores",
       y = "Número de víctimas",
       fill = "") +
  scale_fill_manual(values = c("Observado" = "#2F2F2F",
                               "Rango de imputación JEP-CEV-HRDAG" = "#1F74B1",
  														 "Imputado por donante" = "red"))

plot_homi_perp_imp


ggsave("./output/plot_homi_perp_imp.jpg",
			 plot_homi_perp_imp)
```


